<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>用户管理系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/static_resources/element-plus-index.css" />
    <link rel="stylesheet" href="/static_resources/vxe-table-style.css">
    <script src="/static_resources/vue.global.js"></script>
    <script src="/static_resources/element-plus-index.full.js"></script>
    <script src="/static_resources/xe-utils.js"></script>
    <script src="/static_resources/vxe-table@4.6.25.js"></script>
    <script src="/static_resources/axios.min.js"></script>
    <script src="/static_resources/element-plus_icons-vue.js"></script>
    <script src="/static_resources/zh-cn.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon_logosc/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon_logosc/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon_logosc/favicon-16x16.png">
    <link rel="manifest" href="/favicon_logosc/site.webmanifest">
</head>
<body>
<div id="app" >
    <div class="common-layout">
        <el-container>
            <el-header>
                <div class="header-container" style="display: flex; align-items: center; justify-content: start;">
                    <el-avatar :src="`../img/默认头像.png`"></el-avatar>
                    <h3 class="user-name">管理员</h3>
                </div>
            </el-header>
            <el-container hidden="1080px">
                <el-aside width="200px">
                    <el-menu
                            v-model:default-active="itemNumber"
                            class="el-menu-vertical-demo"
                    >
                        <el-menu-item index="1" @click="toUserManage">
                            <el-icon><User /></el-icon>
                            <span>用户管理</span>
                        </el-menu-item>
                        <el-menu-item index="2" @click="toMerchantManage">
                            <el-icon><Shop /></el-icon>
                            <span>商户管理</span>
                        </el-menu-item>
                        <el-menu-item index="3" @click="toProductManage">
                            <el-icon><Goods /></el-icon>
                            <span>商品管理</span>
                        </el-menu-item>
                        <el-menu-item index="4" @click="toOrderManage">
                            <el-icon><Document /></el-icon>
                            <span>订单管理</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>
                <el-main style="border-top: 1px solid rgb(227, 223, 223);border-left: 1px solid rgb(227, 223, 223);">

                    <template v-if='!isDetail && !isLevel' >
                        <el-row>
                            <el-form :inline="true" :model="form">
                                <el-form-item label="用户账号:"><el-input v-model="form.code" /></el-form-item>
                                <el-form-item label="用户名:"><el-input v-model="form.name" /></el-form-item>
                                <el-form-item label="注册时间:">
                                    <el-date-picker
                                            v-model="this.form.createTime"
                                            type="date"
                                            placeholder="请选择时间"
                                            :size="size"
                                            value-format="YYYY-MM-DD"
                                    />
                                </el-form-item>
                                <el-form-item ><el-button type="primary" @click="onSearch()">查询</el-button></el-form-item>
                                <el-form-item ><el-button  @click="onReset">重置</el-button></el-form-item>
                            </el-form>
                        </el-row>
                        <el-row style="height: 80vh;">
                            <vxe-grid v-bind="gridOptions" style="width: 100%" height="100%">
                                <template #toolbar ><el-button type="primary" @click="add">新增</el-button>
                                    <el-button type="warning" @click="onExport">导出</el-button>
                                    <el-button type="danger" @click="onLevel">会员管理</el-button>
                                </template>
                                <template #valid="{ row }">
                                    <el-switch v-model="row.valid" :active-value=true :inactive-value=false disabled />
                                </template>
                                <template #avatar="{ row }">
                                    <el-image v-if="row.avatar" style="width: 80px; height: 80px" :src="`/MFile/download?id=${row.avatar}`" fit="fill" />
                                </template>
                                <template #operate="{ row }">
                                    <el-button size="small" type="primary" @click="edit(row)">编辑</el-button>
                                    <el-button size="small" type="danger" @click="onRemove(row.id)">删除</el-button>
                                    <el-button size="small" @click="showDetailDialog(row)">详细</el-button>
                                </template>
                                <template #pager>
                                    <vxe-pager :layouts="['Sizes', 'PrevPage', 'Number', 'NextPage', 'Total']" v-model:current-page="page.current" v-model:page-size="page.size" :total="page.total" @page-change="onPageChange">
                                    </vxe-pager>
                                </template>
                            </vxe-grid>
                        </el-row>
                        <el-dialog v-model="showDialog" :title="isEdit ? '编辑' : '新增'" width="400">
                            <el-form ref="editForm" :model="editForm" :rules="rules" label-width="auto">
                                <el-form-item label="头像" prop="avatar">
                                    <!--                    :http-request="uploadAvatar"-->
                                    <el-upload :show-MFile-list="false" :before-upload="uploadAvatar"  >
                                        <img v-if="editForm.avatar" :src="`/MFile/download?id=${editForm.avatar}`" style="width: 100px; height: 100px" />
                                        <el-icon v-else><Plus></Plus></el-icon>
                                    </el-upload>
                                </el-form-item>
                                <el-form-item label="账号" prop="code">
                                    <el-input v-model="editForm.code" :disabled="isEdit" maxlength="20" />
                                </el-form-item>
                                <el-form-item label="名称" prop="name">
                                    <el-input v-model="editForm.name" maxlength="20" />
                                </el-form-item>
                                <el-form-item label="注册城市" prop="city">
                                    <el-cascader v-model="editForm.city" :options="districts" :show-all-levels="true" placeholder="请选择地址" clearable />
                                </el-form-item>
                                <el-form-item label="性别" prop="gender">
                                    <el-radio-group v-model="editForm.gender">
                                        <el-radio :value="'男'">男</el-radio>
                                        <el-radio :value="'女'">女</el-radio>
                                    </el-radio-group>
                                </el-form-item>
                                <el-form-item label="会员等级" prop="level">
                                    <el-radio-group v-model="editForm.levelId">
                                        <template v-for="level in levels">
                                            <el-radio
                                                    :value= "level.levelId"
                                            >
                                                {{ level.levelName }}
                                            </el-radio>
                                        </template>
                                    </el-radio-group>
                                </el-form-item>
                                <el-form-item label="商品分类">
                                    <el-select v-model="editForm.identity" placeholder="请选择" style="width: 240px">
                                        <el-option v-for="item in options" :key="item.value" :label="item.label" :value="item.value"/>
                                    </el-select>
                                </el-form-item>
                                <el-form-item label="创建时间" prop="createTime">
                                    <el-date-picker
                                            v-model="editForm.createTime"
                                            type="date"
                                            placeholder="请选择时间"
                                            :size="size"
                                            value-format="YYYY-MM-DD"
                                    />
                                </el-form-item>
                                <el-form-item v-if="isEdit"  label="有效" prop="valid">
                                    <el-switch v-model="editForm.valid" :active-value=true :inactive-value=false />
                                </el-form-item>
                                <el-form-item  label="密码">
                                    <el-input v-model="editForm.password" />
                                </el-form-item>
                            </el-form>
                            <template #footer>
                                <el-button @click="showDialog = false">取消</el-button>
                                <el-button type="primary"  @click="onSubmit">确定</el-button>
                            </template>
                        </el-dialog>
                    </template>
                    <template v-else-if='isDetail'>
                        <el-button text="plain" @click="isDetail = false"> < 返回</el-button>
                        <el-descriptions
                                title="📖用户详细"
                                direction="vertical"
                                border
                                style="margin-top: 20px"
                        >
                            <el-descriptions-item
                                    :rowspan="3"
                                    :width="140"
                                    label="头像"
                                    align="center"
                            >
                                <div>
                                    <img v-if="detailForm.avatar" :src="`/MFile/download?id=${detailForm.avatar}`" style="width: 100px; height: 100px" />
                                    <el-icon v-else><Plus /></el-icon>
                                </div>
                            </el-descriptions-item>
                            <el-descriptions-item label="用户ID">{{detailForm.id}}</el-descriptions-item>
                            <el-descriptions-item label="用户账号">{{detailForm.code}}</el-descriptions-item>
                            <el-descriptions-item label="用户名">{{detailForm.code}}</el-descriptions-item>
                            <el-descriptions-item label="注册时间">{{detailForm.createTime}}</el-descriptions-item>
                            <el-descriptions-item label="性别">{{detailForm.gender}}</el-descriptions-item>
                            <el-descriptions-item label="城市">{{detailForm.cityName}}</el-descriptions-item>
                        </el-descriptions>
                        <div class="addressTable">
                            <vxe-grid v-bind="addressOptions" style="width: 100%" disabled="false">
                                <template #toolbar >
                                    <h3>📱收货地址</h3>
                                </template>
                            </vxe-grid>
                        </div>
                    </template>

                    <template v-else-if='isLevel'>
                        <el-button  text="plain" @click=" isLevel = false"> < 返回</el-button>
                        <h3>📱角色管理</h3>
                        <hr>
                        <vxe-grid v-bind="levelOptions" style="width: 100%">
                            <template #toolbar >
                                <el-button type="danger" @click="levelAdd">+ 新增</el-button>
                            </template>
                            <template #operate="{ row }">
                                <el-button size="small" type="primary" @click="editLevel(row)">编辑</el-button>
                                <el-button size="small" type="danger" @click="onRemoveLevel(row.id)">删除</el-button>
                            </template>
                        </vxe-grid>
                        <el-dialog v-model="showLevelDialog" :title="isLevelEdit ? '编辑' : '新增'" width="400">
                            <el-form ref="levelForm" :model="levelForm" :rules="levelRules" label-width="auto">
                                <el-form-item label="会员等级名称" prop="levelName">
                                    <el-input v-model="levelForm.levelName" maxlength="20" />
                                </el-form-item>
                                <el-form-item label="折扣" prop="discountRate">
                                    <el-input v-model="levelForm.discountRate" maxlength="20" />
                                </el-form-item>
                            </el-form>
                            <template #footer>
                                <el-button @click="showLevelDialog = false">取消</el-button>
                                <el-button type="primary"  @click="onLevelSubmit">确定</el-button>
                            </template>
                        </el-dialog>
                    </template>
                </el-main>
            </el-container>
        </el-container>
    </div>
</div>

</body>
<script>
    const app = Vue.createApp({
        data(){
            return {
                itemNumber: '1',
                size:'default',
                addressOptions: {
                    border: true,
                    height: 400,
                    data: [],
                    headerAlign: 'center',
                    align: 'center',
                    columns: [
                        {type: 'seq', width: 60},
                        {field: 'receiver', title: '名称'},
                        {field: 'telephone', title: '电话'},
                        {field: 'detailAddress', title: '详细地址'},
                        {field: 'zipCode', title: '邮政编码'},
                        {field: 'default', title: '默认地址',formatter: ({cellValue}) => {
                                return cellValue === true ? '✔' : '❌️';}}
                    ],
                    toolbarConfig: {
                        custom: true,
                        slots: {buttons: 'toolbar_buttons'}
                    },
                },
                options: [
                    {
                        value: 'user',
                        label: '普通用户',
                    },
                    {
                        value: 'merchant',
                        label: '商户',
                    },
                    {
                        value: 'admin',
                        label: '管理员',
                    },
                ],
                levels:[],
                memberLevelMap: {},
                form: {
                    code: '',
                    name: '',
                    createTime: ''
                },
                gridOptions: {
                    border: true,
                    height: 400,
                    data: [],
                    headerAlign: 'center',
                    align: 'center',
                    columns: [
                        {type: 'seq', width: 60},
                        {field: 'code', title: '账号'},
                        {field: 'name', title: '名称'},
                        {field: 'gender', title: '性别'},
                        {field: 'levelId', title: '会员等级', formatter: ({cellValue}) => {
                                return this.memberLevelMap[cellValue] || `未知等级`;}
                        },
                        {field: 'createTime', title: '创建时间'},
                        {field: 'valid', title: '有效', slots: {default: 'valid'}, width: 80} ,
                        {field: 'avatar', title: '头像', slots: {default: 'avatar'}, width: 110},
                        {title: '操作', slots: {default: 'operate'}, width: 220}
                    ],
                    toolbarConfig: {
                        custom: true,
                        slots: {buttons: 'toolbar_buttons'}
                    },
                },
                levelOptions: {
                    border: true,
                    height: 400,
                    data: [],
                    headerAlign: 'center',
                    align: 'center',
                    columns: [
                        {type: 'seq', width: 60},
                        {field: 'levelName',title: '会员等级'},
                        {field: 'discountRate',title: '折扣'},
                        {title: '操作', slots: {default: 'operate'}, width: 220}
                    ],
                    toolbarConfig: {
                        custom: true,
                        slots: {buttons: 'toolbar_buttons'}
                    },
                },
                page: {
                    current: 1,
                    size: 20,
                    total: 0
                },
                isEdit: false,
                showDialog: false,
                isDetail: false,
                isLevel: false,
                isLevelEdit: false,
                showLevelDialog: false,
                editForm: {
                    id: '',
                    code: '',
                    name: '',
                    city: '',
                    gender: '',
                    levelId: '',
                    createTime: '',
                    valid: true,
                    avatar: '',
                    password: '',
                    identity:'',
                },
                detailForm: {
                    id: '',
                    code: '',
                    name: '',
                    city: '',
                    gender: '',
                    createTime: '',
                    avatar: '',
                    cityName:'',
                },
                levelForm:{
                    levelName: '',
                    discountRate: ''
                },
                rules: {
                    code: [{required: true, message: '请输入账号'}],
                    name: [{required: true, message: '请输入名称'}],
                    password: [{required: true, message: '请输入密码'},
                        {
                            validator(rule, value, callback) {
                                if (value) {
                                    if (/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z\W]{6,18}$/.test(value)) {
                                        callback();
                                    } else {
                                        callback(new Error('请输入包含英文和数字，在6-18位之间'))
                                    }
                                } else {
                                    callback();
                                }
                            },
                            trigger: 'blur'
                        }
                    ],
                },
                levelRules: {
                    levelName: [{required: true, message: '请输入会员名称'}],
                    discountRate: [{required: true, message: '请输入会员折扣'}]
                },
                districts:[],
            }
        },
        async created(){
            await this.initDistricts();
            await this.initLevel();
            await this.getList();
        },
        methods: {
            async initLevel() {
                const response = await axios.post('/user/initLevel');
                this.levels = response.data;
                this.memberLevelMap = Object.fromEntries(
                    this.levels.map(level => [level.levelId, level.levelName])
                );
            },
            async initDistricts() {
                const response = await axios.post('/user/initDistricts');
                // 转换所有value为字符串
                const convertValues = (nodes) => {
                    return nodes.map(node => ({
                        ...node,
                        value: String(node.value), // 强制转为字符串
                        children: node.children ? convertValues(node.children) : []
                    }));
                };

                this.districts = convertValues(response.data);
                console.log(this.districts);
            },
            onSearch() {
                this.getList();
            },
            onPageChange() {
                this.getList();
            },
            async getList() {
                console.log(this.form.createTime)
                const form = this.form;
                const response = await axios.post("/user/getList", {
                    code: form.code,
                    name: form.name,
                    createTime: form.createTime,
                    current: this.page.current,
                    size: this.page.size
                });
                this.gridOptions.data = response.data.records;
                this.page.current = response.data.current;
                this.page.size = response.data.size;
                this.page.total = response.data.total;
                console.log(this.gridOptions.data);

            },
            onReset() {
                this.form.code = '';
                this.form.name = '';
                this.form.createTime = '';
                this.getList();
            },
            async onRemove(id) {
                await axios.post('/user/remove', {id});
                await this.getList();
            },
            async onExport() {
                const form = this.form;
                // await axios.post("/user/export", {
                //     code: form.code,
                //     name: form.name,
                //     createTime: form.createTime,
                //     current: this.page.current,
                //     size: this.page.size
                // });
                window.location.href = `/user/export?code=${this.form.code}&createTime=${this.form.createTime}&current=${this.page.current}&name=${this.form.name}&size=${this.page.size}`;
                // await this.getList();
            },
            add() {
                this.showDialog = true;
                this.isEdit = false;
                this.editForm = {};
            },
            async uploadAvatar(f) {
                try {
                    // const { file } = options;  // 从参数中获取文件对象
                    // const formData = new FormData();
                    // formData.append('MFile', file);  // 使用标准字段名

                    const response = await axios.post('/MFile/upload', {MFile: f}, {
                        headers: {'Content-Type': 'multipart/form-data'}
                    });
                    this.editForm.avatar = response.data.id;
                    return false;
                } catch (error) {
                    console.error('上传失败', error);
                    // 添加错误提示
                }
            },
            onSubmit() {
                this.$refs.editForm.validate(async valid => {
                        if (valid) {
                            if (Array.isArray(this.editForm.city)) {
                                this.editForm.city = Number(this.editForm.city[this.editForm.city.length - 1]); // 转换为数字
                            }
                            await axios.post(this.isEdit ? '/user/edit' : '/user/add', this.editForm);
                            await this.getList();
                            this.showDialog = false;
                        }
                    }
                );
            },
            edit(user) {
                this.showDialog = true;
                this.isEdit = true;
                this.editForm = {...user};
            },
            getUserAddress(id){
                axios.post('/address/getUserAddress',
                    {id: id}
                ).then(response => {
                    try{
                        this.addressOptions.data = response.data.records;
                    }catch(error){
                        console.log(error);
                    }
                });
            },
            showDetailDialog(user) {
                this.isDetail = true;
                this.addressOptions.data = [];
                this.getUserAddress(user.id);
                this.detailForm.id = user.id;
                this.detailForm.code = user.code;
                this.detailForm.name = user.name;
                this.detailForm.city = user.city;
                this.detailForm.gender = user.gender;
                this.detailForm.createTime = user.createTime;
                this.detailForm.avatar = user.avatar;
            },
            // 根据地区编码获取地区名称
            getFullRegionPath(districts, districtCode) {
                // 1. 查找目标节点并记录路径
                const findPath = (nodes, code, path = []) => {
                    for (const node of nodes) {
                        // 检查当前节点
                        if (node.value === code) {
                            return [...path, node.label];
                        }

                        // 递归检查子节点
                        if (node.children && node.children.length) {
                            const found = findPath(
                                node.children,
                                code,
                                [...path, node.label]  // 添加当前节点到路径
                            );
                            if (found) return found;
                        }
                    }
                    return null;
                };
                const path = findPath(districts, districtCode);
                return path ? path.join(' ') : '';
            },
            updateCityName() {
                if (this.detailForm.city != null) {
                    this.detailForm.cityName = this.getFullRegionPath(this.districts,this.detailForm.city);
                } else {
                    // this.detailForm.cityName = '';
                }
            },
            onLevel(){
                this.isLevel = true;
                this.levelOptions.data = [];
                this.levelGetList();
            },
            editLevel(level){
                this.showLevelDialog = true;
                this.isLevelEdit = true;
                this.levelForm = {...level};
            },
            levelAdd() {
                this.showLevelDialog = true;
                this.isLevelEdit = false;
                this.levelForm = {};
            },
            async onRemoveLevel(id){
                await axios.post('/level/remove', {id});
                await this.levelGetList();
            },
            levelGetList(){
                axios.post('/level/getLevels').then(response => {
                    try{
                        this.levelOptions.data = response.data.records;
                    }catch(error){
                        console.log(error);
                    }
                });
            },
            async onLevelSubmit(){
                this.$refs.levelForm.validate(async valid => {
                        if (valid) {
                            await axios.post(this.isLevelEdit ? '/level/edit' : '/level/add', this.levelForm);
                            await this.levelGetList();
                            this.showLevelDialog = false;
                        }
                    }
                );
            },
            toUserManage(){
                window.location.href = 'http://localhost:8080/userAdmin';
            },
            toMerchantManage(){
                window.location.href = 'http://localhost:8080/merchantAdmin';
            },
            toProductManage(){
                window.location.href = 'http://localhost:8080/productAdmin';
            },
            toOrderManage(){
                window.location.href = 'http://localhost:8080/orderAdmin';
            }
        },
        watch: {
            'detailForm.city':function(newValue, oldValue) {
                this.updateCityName();
            }
        }

    });
    for(const[key, component] of Object.entries(ElementPlusIconsVue)) {app.component(key, component)}
    app.use(ElementPlus,{
        locale: ElementPlusLocaleZhCn,
    }).use(VxeUITable).mount('#app');
</script>
</html>