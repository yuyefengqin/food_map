<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ÂïÜÊà∑ÁÆ°ÁêÜ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/static_resources/element-plus-index.css" />
    <link rel="stylesheet" href="/static_resources/vxe-table-style.css">
    <script src="/static_resources/vue.global.js"></script>
    <script src="/static_resources/element-plus-index.full.js"></script>
    <script src="/static_resources/xe-utils.js"></script>
    <script src="/static_resources/vxe-table@4.6.25.js"></script>
    <script src="/static_resources/axios.min.js"></script>
    <script src="/static_resources/element-plus_icons-vue.js"></script>
    <script src="/static_resources/zh-cn.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon_logosc/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon_logosc/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon_logosc/favicon-16x16.png">
    <link rel="manifest" href="/favicon_logosc/site.webmanifest">
</head>
<body>
<div id="app">
    <div class="common-layout">
        <el-container>
            <el-header>
                <div class="header-container" style="display: flex; align-items: center; justify-content: start;">
                    <el-avatar :src="`../img/ÈªòËÆ§Â§¥ÂÉè.png`"></el-avatar>
                    <h3 class="user-name">ÁÆ°ÁêÜÂëò</h3>
                </div>
            </el-header>
            <el-container hidden="1080px">
                <el-aside width="200px">
                    <el-menu
                            v-model:default-active="itemNumber"
                            class="el-menu-vertical-demo"
                    >
                        <el-menu-item index="1" @click="toUserManage">
                            <el-icon>
                                <document/>
                            </el-icon>
                            <span>Áî®Êà∑ÁÆ°ÁêÜ</span>
                        </el-menu-item>
                        <el-menu-item index="2" @click="toMerchantManage">
                            <el-icon>
                                <document/>
                            </el-icon>
                            <span>ÂïÜÊà∑ÁÆ°ÁêÜ</span>
                        </el-menu-item>
                        <el-menu-item index="3" @click="toProductManage">
                            <el-icon>
                                <document/>
                            </el-icon>
                            <span>ÂïÜÂìÅÁÆ°ÁêÜ</span>
                        </el-menu-item>
                        <el-menu-item index="4" @click="toOrderManage">
                            <el-icon>
                                <setting/>
                            </el-icon>
                            <span>ËÆ¢ÂçïÁÆ°ÁêÜ</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>
                <el-main>
                    <strong>ÂïÜÂÆ∂ÂàóË°®</strong>

                    <template v-if=!isDetail>
                        <el-row>
                            <el-form :inline="true" :model="form">
                                <el-form-item label="ÂïÜÊà∑ÁºñÂè∑">
                                    <el-input v-model="form.merchantId" clearable/>
                                </el-form-item>
                                <el-form-item label="ÂïÜÊà∑ÂêçÁß∞">
                                    <el-input v-model="form.merchantName" clearable/>
                                </el-form-item>
                                <el-form-item label="ÂàõÂª∫Êó∂Èó¥">
                                    <el-date-picker v-model="form.createTime" type="date" placeholder="Pick a day"
                                                    :size="form.size"/>
                                </el-form-item>
                            </el-form>
                            <el-form :inline="true" :model="form">
                                <el-form-item label="Áä∂ÊÄÅ">
                                    <el-select v-model="form.status" placeholder="ËØ∑ÈÄâÊã©" style="width: 240px">
                                        <el-option v-for="item in options" :key="item.value" :label="item.label"
                                                   :value="item.value"/>
                                    </el-select>
                                </el-form-item>
                                <el-form-item label="ÂïÜÊà∑ÁÆ°ÁêÜË¥¶Âè∑">
                                    <el-input v-model="form.manageAccount" clearable/>
                                </el-form-item>
                                <el-form-item>
                                    <el-button type="primary" @click="onSearch">Êü•ËØ¢</el-button>
                                </el-form-item>
                                <el-form-item>
                                    <el-button type="primary" @click="onDelete">ÈáçÁΩÆ</el-button>
                                </el-form-item>
                            </el-form>
                        </el-row>

                        <!--    Ë°®Ê†º-->
                        <el-row style="height: 80vh;">
                            <vxe-grid v-bind="gridOptions" style="width: 100%" height="100%">

                                <!--            Êü•ËØ¢ÊåâÈíÆÔºà1.Á±ªÂûã 2.ÁÇπÂáªÂêéËß¶ÂèëÊñπÊ≥ï 3.ÊåâÈíÆÊòæÁ§∫ÂÜÖÂÆπÔºâ-->
                                <template #toolbar_buttons>
                                    <el-button type="primary" @click="add">Êñ∞Â¢û</el-button>
                                </template>

                                <!--            ÊúâÊïà-->
                                <template #valid="{ row }">
                                    <el-switch v-model="row.status" :active-value="1" :inactive-value="0" disabled/>
                                </template>


                                <!--            Êìç‰Ωú-->
                                <template #operate="{ row }">
                                    <el-button size="small" type="primary" @click="showDetailDialog(row)">Êü•Áúã</el-button>
                                    <el-button size="small" type="primary" @click="edit(row)">ÁºñËæë</el-button>
                                    <el-button size="small" type="danger" @click="onRemove(row.merchantId)">Âà†Èô§
                                    </el-button>
                                </template>

                                <!--            Êç¢È°µ-->
                                <template #pager>
                                    <vxe-pager :layouts="['Sizes', 'PrevPage', 'Number', 'NextPage', 'Total']"
                                               v-model:current-page="page.current" v-model:page-size="page.size"
                                               :total="page.total" @page-change="onPageChange">
                                    </vxe-pager>
                                </template>
                            </vxe-grid>
                            <!--       ÁºñËæëÂíåÊñ∞Â¢ûÈ°µÈù¢-->
                            <el-dialog v-model="showDialog" :title="isEdit ? 'ÁºñËæë' : 'Êñ∞Â¢û'" width="400">
                                <el-form ref="editForm" :model="editForm" :rules="rules" label-width="auto">

                                    <!--                ÂïÜÊà∑ÁÆ°ÁêÜË¥¶Âè∑-->
                                    <el-form-item label="ÂïÜÊà∑ÁÆ°ÁêÜË¥¶Âè∑" prop="manageAccount">
                                        <el-input v-model="editForm.manageAccount" :disabled="isEdit" maxlength="20"/>
                                    </el-form-item>

                                    <!--                ÂïÜÊà∑ÁÆ°ÁêÜÂØÜÁ†Å-->
                                    <el-form-item v-if="!isEdit" label="ÂïÜÊà∑ÁÆ°ÁêÜÂØÜÁ†Å" prop="managePassword">
                                        <el-input v-model="editForm.managePassword"/>
                                    </el-form-item>

                                    <!--                ÂïÜÊà∑ÂêçÁß∞-->
                                    <el-form-item label="ÂïÜÊà∑ÂêçÁß∞" prop="merchantName">
                                        <el-input v-model="editForm.merchantName" maxlength="20"/>
                                    </el-form-item>

                                    <!--                ÂïÜÊà∑Âú∞ÂùÄ-->
                                    <el-form-item label="ÂïÜÊà∑Âú∞ÂùÄ" prop="merchantAddress">
                                        <el-input v-model="editForm.merchantAddress" maxlength="20"/>
                                    </el-form-item>

                                    <!--                ÂïÜÊà∑ËÅîÁ≥ªÊñπÂºè-->
                                    <el-form-item label="ÂïÜÊà∑ËÅîÁ≥ªÊñπÂºè" prop="contactPhone">
                                        <el-input v-model="editForm.contactPhone" maxlength="20"/>
                                    </el-form-item>

                                    <!--                ‰∏ä‰º†Ëê•‰∏öÊâßÁÖß-->
                                    <el-form-item label="‰∏ä‰º†Ëê•‰∏öÊâßÁÖß" prop="businessLicense">
                                        <el-upload :show-MFile-list="false" :before-upload="uploadLicense">
                                            <img v-if="editForm.businessLicense"
                                                 :src="`/MFile/download?id=${editForm.businessLicense}`"
                                                 style="width: 100px; height: 100px"/>
                                            <el-icon v-else>
                                                <Plus/>
                                            </el-icon>
                                        </el-upload>
                                    </el-form-item>

                                    <!--                ‰∏ä‰º†logo-->
                                    <el-form-item label="‰∏ä‰º†Logo" prop="logoUrl">
                                        <el-upload :show-MFile-list="false" :before-upload="uploadLogo">
                                            <img v-if="editForm.logoUrl" :src="`/MFile/download?id=${editForm.logoUrl}`"
                                                 style="width: 100px; height: 100px"/>
                                            <el-icon v-else>
                                                <Plus/>
                                            </el-icon>
                                        </el-upload>
                                    </el-form-item>

                                    <!--                ‰ºÅ‰∏öÁ±ªÂûã-->
                                    <el-form-item label="‰ºÅ‰∏öÁ±ªÂûã" prop="enterpriseType">
                                        <el-input v-model="editForm.enterpriseType"/>
                                    </el-form-item>

                                    <!--                Â§áÊ≥®-->
                                    <el-form-item label="Â§áÊ≥®" prop="notes">
                                        <el-input v-model="editForm.notes" maxlength="50"/>
                                    </el-form-item>
                                    <!--                ÊúâÊïà-->
                                    <el-form-item v-if="isEdit" label="ÊúâÊïà" prop="status">
                                        <el-switch v-model="editForm.status" :active-value="1" :inactive-value="0"/>
                                    </el-form-item>

                                </el-form>

                                <template #footer>
                                    <el-button type="primary" @click="onSubmit">Êèê‰∫§</el-button>
                                    <el-button @click="showDialog = false">ÂèñÊ∂à</el-button>
                                </template>
                            </el-dialog>
                        </el-row>
                    </template>
                    <!--    ËØ¶ÁªÜË°®ÔºàÂïÜÊà∑Ôºâ-->
                    <template v-else-if='isDetail'>
                        <el-button text="plain" @click="isDetail = false"> < ËøîÂõû</el-button>
                        <el-descriptions
                                title="üìñÂïÜÂìÅËØ¶ÁªÜ"
                                direction="vertical"
                                border
                                style="margin-top: 20px"
                        >
                            <el-descriptions-item
                                    :rowspan="3"
                                    :width="140"
                                    label="LOGO"
                                    align="center"
                            >
                                <div>
                                    <img v-if="detailForm.logoUrl" :src="`/MFile/download?id=${detailForm.logoUrl}`" style="width: 100px; height: 100px" />
                                    <el-icon v-else><Plus /></el-icon>
                                </div>
                            </el-descriptions-item>
                            <el-descriptions-item label="ÂïÜÊà∑ÁºñÂè∑">{{detailForm.merchantId}}</el-descriptions-item>
                            <el-descriptions-item label="ÂïÜÊà∑ÂêçÁß∞">{{detailForm.merchantName}}</el-descriptions-item>
                            <el-descriptions-item label="ÂïÜÊà∑Â§áÊ≥®">{{detailForm.notes}}</el-descriptions-item>
                            <el-descriptions-item label="ÊâÄÂú®ÂüéÂ∏Ç">{{detailForm.merchantAddress}}</el-descriptions-item>
                            <el-descriptions-item label="ËÅîÁ≥ª‰∫∫ÁîµËØù">{{detailForm.contactPhone}}</el-descriptions-item>
                            <el-descriptions-item label="‰ºÅ‰∏öÁ±ªÂûã">{{detailForm.enterpriseType}}</el-descriptions-item>
                            <el-descriptions-item label="ÂïÜÊà∑ÁÆ°ÁêÜË¥¶Âè∑">{{detailForm.manageAccount}}</el-descriptions-item>
                            <el-descriptions-item label="ÂïÜÊà∑Áä∂ÊÄÅ">{{detailForm.status}}</el-descriptions-item>
                            <el-descriptions-item label="ÂàõÂª∫Êó∂Èó¥">{{detailForm.createTime}}</el-descriptions-item>
                            <el-descriptions-item
                                    :rowspan="3"
                                    :width="140"
                                    label="Ëê•‰∏öÊâßÁÖß"
                                    align="center"
                            >
                                <div>
                                    <img v-if="detailForm.businessLicense" :src="`/MFile/download?id=${detailForm.businessLicense}`" style="width: 100px; height: 100px" />
                                    <el-icon v-else><Plus /></el-icon>
                                </div>
                            </el-descriptions-item>
                        </el-descriptions>
                    </template>

                </el-main>
            </el-container>
        </el-container>
    </div>

</div>
</body>
<script>
    const app = Vue.createApp({
        data() {
            return {
                itemNumber: '2',
                districts: [],
                // Êü•ËØ¢ÁïåÈù¢
                form: {
                    merchantId: '',
                    merchantName: '',
                    createTime: '',
                    status: '',
                    merchantAddress: '',
                },
                //Áä∂ÊÄÅÁöÑ‰∏Ä‰∏™ÂºÄÂÖ≥
                options: [
                    {
                        value: '1',
                        label: 'ÂºÄ',
                    },
                    {
                        value: '0',
                        label: 'ÂÖ≥',
                    },
                ],
                // Ë°®Ê†º
                gridOptions: {
                    border: true,
                    height: 400,
                    data: [],
                    headerAlign: 'center',
                    align: 'center',
                    columns: [
                        {type: 'seq', width: 60},
                        {field: 'merchantId', title: 'ÂïÜÊà∑ÁºñÂè∑'},
                        {field: 'merchantName', title: 'ÂïÜÊà∑ÂêçÁß∞'},
                        {field: 'manageAccount', title: 'ÂïÜÊà∑ÁÆ°ÁêÜË¥¶Âè∑'},
                        {field: 'enterpriseType', title: '‰ºÅ‰∏öÁ±ªÂûã'},
                        {field: 'status', title: 'ÂïÜÊà∑Áä∂ÊÄÅ', slots: {default: 'valid'}, width: 80},
                        {field: 'createTime', title: 'ÂàõÂª∫Êó∂Èó¥'},
                        {title: 'Êìç‰Ωú', slots: {default: 'operate'}, width: 220}
                    ],
                    toolbarConfig: {
                        custom: true,
                        slots: {buttons: 'toolbar_buttons'}
                    },
                },
                page: {
                    current: 1,
                    size: 20,
                    total: 0
                },
                //ÁºñËæë
                showDialog: false,
                //Êñ∞Â¢û
                isEdit: false,
                //ÁºñËæëÂíåÊñ∞Â¢ûÁöÑÁïåÈù¢
                editForm: {
                    merchantId: '',
                    manageAccount: '',
                    merchantName: '',
                    enterpriseType: '',
                    contactPhone: '',
                    merchantAddress: '',
                    status: 1,
                    businessLicense: '',
                    logoUrl: '',
                    managePassword: '',
                    notes: ''
                },
                // ËØ¶ÁªÜÂÜÖÂÆπ
                isDetail: false,
                detailForm: {
                    logoUrl: '',
                    merchantId: '',
                    merchantName: '',
                    notes: '',
                    merchantAddress: '',
                    contactPhone: '',
                    enterpriseType: '',
                    manageAccount: '',
                    managePassword: '',
                    status: '',
                    createTime: '',
                    businessLicense: '',
                },
                rules: {
                    merchantId: [{ required: true, message: 'ËØ∑ËæìÂÖ•Ë¥¶Âè∑', trigger: 'blur' },
                        {
                            validator(rule, value, callback) {
                                if (value) {
                                    if (/^[a-zA-Z0-9_]{2,20}$/.test(value)) {
                                        callback();
                                    } else {
                                        callback(new Error('Ë¥¶Âè∑ÈúÄ‰∏∫2-20‰ΩçÂ≠óÊØç„ÄÅÊï∞Â≠óÊàñ‰∏ãÂàíÁ∫ø'));
                                    }
                                } else {
                                    callback();
                                }
                            },
                            trigger: 'blur'
                        }
                    ],
                    merchantName: [{ required: true, message: 'ËØ∑ËæìÂÖ•ÂêçÁß∞', trigger: 'blur' },
                        {
                            validator(rule, value, callback) {
                                if (value) {
                                    // ÂêçÁß∞ÊòØ2-50‰ΩçÂ≠óÁ¨¶ÔºàÂ∫îËØ•ÊòØÂè™Êúâ‰∏≠ÊñáÁöÑÔºâ
                                    if (/^.{2,50}$/.test(value)) {
                                        callback();
                                    } else {
                                        callback(new Error('ÂêçÁß∞ÈïøÂ∫¶ÈúÄÂú®2-50‰Ωç‰πãÈó¥'));
                                    }
                                } else {
                                    callback();
                                }
                            },
                            trigger: 'blur'
                        }
                    ],
                    contactPhone: [{required: true, message: 'ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑',trigger: 'blur'},
                        {
                            validator(rule, value, callback) {
                                if (value) {
                                    if (/^(?:0|86|\+86)?1[3-9]\d{9}$/.test(value)) {
                                        callback();
                                    } else {
                                        callback(new Error('ÊâãÊú∫Ê†ºÂºèÈîôËØØ'))
                                    }
                                } else {
                                    callback();
                                }
                            }, trigger: 'blur'
                        }],
                    password: [{required: true, message: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å'},
                        {
                            validator(rule, value, callback) {
                                if (value) {
                                    if (/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z\W]{6,18}$/.test(value)) {
                                        callback();
                                    } else {
                                        callback(new Error('ËØ∑ËæìÂÖ•ÂåÖÂê´Ëã±ÊñáÂíåÊï∞Â≠óÔºåÂú®6-18‰Ωç‰πãÈó¥'))
                                    }
                                } else {
                                    callback();
                                }
                            },
                            trigger: 'blur'
                        }
                    ],
                    manageAccount: [
                        { required: true, message: 'ËØ∑ËæìÂÖ•ÁÆ°ÁêÜË¥¶Âè∑', trigger: 'blur' },
                        {
                            validator(rule, value, callback) {
                                if (value) {
                                    if (/^(?:0|86|\+86)?1[3-9]\d{9}$/.test(value) || /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)])/.test(value)) {
                                        callback();
                                    } else {
                                        callback(new Error('ÈÇÆÁÆ±ÊàñÊâãÊú∫Ê†ºÂºèÈîôËØØ'))
                                    }
                                } else {
                                    callback();
                                }
                            }, trigger: 'blur'
                        }
                    ]
                },
            };
        },
        async created() {
            await this.getList();
        },
        methods: {
            //ÂàùÂßãÂåñÊñπÊ≥ï
            async init() {
                const response = await axios.post('/merchant/init');
                // ËΩ¨Êç¢ÊâÄÊúâvalue‰∏∫Â≠óÁ¨¶‰∏≤
                // const convertValues = (nodes) => {
                //     return nodes.map(node => ({
                //         ...node,
                //         value: String(node.value), // Âº∫Âà∂ËΩ¨‰∏∫Â≠óÁ¨¶‰∏≤
                //         children: node.children ? convertValues(node.children) : []
                //     }));
                // };
                //
                // this.districts = convertValues(response.data);
                // console.log(this.districts);
            },
            //Êç¢È°µÁöÑÊõ¥Êñ∞
            onPageChange() {
                this.getList();
            },

            async getList() {
                const form = this.form;
                const response = await axios.post('/merchant/getList', {
                    merchantId: form.merchantId,
                    merchantName: form.merchantName,
                    createTime: form.createTime,
                    status: form.status,
                    manageAccount: form.manageAccount,
                    current: this.page.current,
                    size: this.page.size
                });
                this.gridOptions.data = response.data.records;
                this.page.current = response.data.current;
                this.page.size = response.data.size;
                this.page.total = response.data.total;
                console.log(this.gridOptions.data);
            },
            //ÁºñËæëÊåâÈíÆ
            edit(merchant) {
                this.showDialog = true;
                this.isEdit = true;
                this.editForm = {...merchant};
            },
            //Êñ∞Â¢ûÊåâÈíÆ
            add() {
                this.showDialog = true;
                this.isEdit = false;
                this.editForm = {};
                this.editForm.status = 1;
            },
            //Êü•ËØ¢ÊåâÈíÆ
            onSearch() {
                this.getList();
            },
            onDelete() {
                this.form.merchantId = '';
                this.form.merchantName = '';
                this.form.createTime = '';
                this.form.status = '';
                this.form.manageAccount = '';
            },
            //ÁßªÈô§ÂäüËÉΩ
            async onRemove(merchantId) {
                await axios.post('/merchant/remove', {merchantId});
                await this.getList();
            },
            async uploadLogo(f) {
                try {
                    const response = await axios.post('/MFile/upload', {MFile: f}, {
                        headers: {'Content-Type': 'multipart/form-data'}
                    });

                    this.editForm.logoUrl = response.data.id;
                    return false;
                } catch (error) {
                    console.error('‰∏ä‰º†Â§±Ë¥•', error);
                    // Ê∑ªÂä†ÈîôËØØÊèêÁ§∫
                }
            },

            async uploadLicense(f) {
                try {
                    const response2 = await axios.post('/MFile/upload', {MFile: f}, {
                        headers: {'Content-Type': 'multipart/form-data'}
                    });

                    this.editForm.businessLicense = response2.data.id;
                    return false;
                } catch (error) {
                    console.error('‰∏ä‰º†Â§±Ë¥•', error);
                    // Ê∑ªÂä†ÈîôËØØÊèêÁ§∫
                }
            },
            onSubmit() {
                this.$refs.editForm.validate(async valid => {
                        if (valid) {
                            await axios.post(this.isEdit ? '/merchant/edit' : '/merchant/add', this.editForm);
                            await this.getList();
                            this.showDialog = false;
                        }
                    }
                );
            },
            showDetailDialog(merchant) {
                this.isDetail = true;
                this.detailForm.merchantId = merchant.merchantId;
                this.detailForm.merchantName = merchant.merchantName;
                this.detailForm.notes = merchant.notes;
                this.detailForm.merchantAddress = merchant.merchantAddress;
                this.detailForm.contactPhone = merchant.contactPhone;
                this.detailForm.enterpriseType = merchant.enterpriseType;
                this.detailForm.logoUrl = merchant.logoUrl;
                this.detailForm.businessLicense = merchant.businessLicense;
                this.detailForm.manageAccount = merchant.manageAccount;
                this.detailForm.managePassword = merchant.managePassword;
                this.detailForm.status = merchant.status;
                this.detailForm.createTime = merchant.createTime;
            },
            toUserManage() {
                window.location.href = 'http://localhost:8080/user.html';
            },
            toMerchantManage() {
                window.location.href = 'http://localhost:8080/merchant.html';
            },
            toProductManage() {
                window.location.href = 'http://localhost:8080/product.html';
            },
            toOrderManage() {
                window.location.href = 'http://localhost:8080/order.html';
            }
        }
    });
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component)
    }
    app.use(ElementPlus).use(VxeUITable).mount('#app');
</script>
</html>


