<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Áî®Êà∑ÁöÑËØ¶ÊÉÖ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <script src="/static_resources/vue.global.js"></script>
    <link rel="stylesheet" href="/static_resources/element-plus-index.css" />
    <link rel="stylesheet" href="/static_resources/vxe-table-style.css">
    <script src="/static_resources/element-plus-index.full.js"></script>
    <script src="/static_resources/xe-utils.js"></script>
    <script src="/static_resources/vxe-table@4.6.25.js"></script>
    <script src="/static_resources/axios.min.js"></script>
    <script src="/static_resources/element-plus_icons-vue.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon_logosc/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon_logosc/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon_logosc/favicon-16x16.png">
    <link rel="manifest" href="/favicon_logosc/site.webmanifest">
    <link rel="stylesheet" href="./static_resources/userDetail.css" />
</head>
<body>
<div id="app">
    <div class="top-nav">
        <div class="container">
            <div class="content">
                <h2>ÁæéÈ£üÂú∞ÂõæÊ¨¢Ëøé‰Ω†</h2>
                <el-button type="primary" @click="backStore"><el-icon><Shop /></el-icon>ËøîÂõû</el-button>
            </div>
        </div>
    </div>
    <div class="container" >
        <div class="common-layout">
            <el-container>
                <el-header>
                    <div class="header">
                        <el-avatar v-if="loginedUserData.avatar" :size="50" :src="`http://localhost:8080/MFile/download?id=${loginedUserData.avatar}`" ></el-avatar>
                        <el-avatar v-else :size="50" ><Plus /></el-avatar>
                        <h3 v-if="loginedUserData.name">{{loginedUserData.name}}</h3>
                        <h3 v-else>Áî®Êà∑Âêç</h3>
                    </div>
                </el-header>
                <el-container>
                    <el-aside width="200px">
                        <el-menu
                                v-model:default-active="itemNumber"
                                class="el-menu-vertical-demo"
                        >
                            <el-menu-item index="1" @click="toUserDetail">
                                <el-icon><User /></el-icon>
                                <span>ËØ¶ÁªÜ‰ø°ÊÅØ</span>
                            </el-menu-item>
                            <el-menu-item index="2" @click="toShoppingCart">
                                <el-icon><Dish /></el-icon>
                                <span>Ë¥≠Áâ©ËΩ¶</span>
                            </el-menu-item>
                            <el-menu-item index="3" @click="toOrder">
                                <el-icon><document /></el-icon>
                                <span>ÊàëÁöÑËÆ¢Âçï</span>
                            </el-menu-item>
                            <el-menu-item index="4" @click="toSetting">
                                <el-icon><setting /></el-icon>
                                <span>ËÆæÁΩÆ</span>
                            </el-menu-item>
                            <el-menu-item index="5" @click="toAddressManage">
                                <el-icon><Location /></el-icon>
                                <span>Âú∞ÂùÄÁÆ°ÁêÜ</span>
                            </el-menu-item>
                        </el-menu>
                    </el-aside>
                    <el-main>
                        <div v-if="isAddressPage">

                            <div class="title-content">
                                <h2>Êî∂Ë¥ßÂú∞ÂùÄÁÆ°ÁêÜ</h2>
                                <el-button type="primary" @click="showAddDialog">+ Êñ∞Â¢ûÂú∞ÂùÄ</el-button>
                            </div>

                            <!-- Âú∞ÂùÄË°®Ê†ºÔºà‰ΩøÁî®vxe-grid‰øùÊåÅ‰∏éÁî®Êà∑ËØ¶ÊÉÖÈ°µÈ£éÊ†º‰∏ÄËá¥Ôºâ -->
                            <vxe-grid
                                    border
                                    height="400"
                                    :data="addressList"
                                    :columns="addressColumns"
                                    :toolbar-config="{ custom: true, slots: { buttons: 'address_toolbar' } }"
                            >
                                <template #address_toolbar>
                                    <!-- Â∑•ÂÖ∑Ê†èÈ¢ùÂ§ñÊåâÈíÆÂèØÂú®Ê≠§Ê∑ªÂä† -->
                                </template>
                                <template #default="{ row }">
                                    <!-- Êìç‰ΩúÂàóËá™ÂÆö‰πâÊåâÈíÆ -->
                                    <el-button size="small" @click="handleEdit(row)">ÁºñËæë</el-button>
                                    <el-button size="small" type="danger" @click="handleDelete(row.addressId)">Âà†Èô§</el-button>
                                </template>
                            </vxe-grid>

                            <!-- ÂàÜÈ°µÁªÑ‰ª∂ -->
                            <el-pagination
                                    @current-change="handlePageChange"
                                    :current-page="currentPage"
                                    :page-size="pageSize"
                                    :total="total"
                                    style="margin-top: 10px; text-align: right;"
                            ></el-pagination>

                            <!-- Êñ∞Â¢û/ÁºñËæëÂú∞ÂùÄÂºπÁ™ó -->
                            <el-dialog :title="isEdit ? 'ÁºñËæëÂú∞ÂùÄ' : 'Êñ∞Â¢ûÂú∞ÂùÄ'" v-model="dialogVisible">
                                <el-form :model="addressForm" ref="addressForm" label-width="100px">
                                    <el-form-item label="Êî∂‰ª∂‰∫∫" :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•Êî∂‰ª∂‰∫∫', trigger: 'blur' }]">
                                        <el-input v-model="addressForm.receiver"></el-input>
                                    </el-form-item>
                                    <el-form-item label="ÁîµËØù" :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•ÁîµËØù', trigger: 'blur' }]">
                                        <el-input v-model="addressForm.telephone"></el-input>
                                    </el-form-item>
                                    <el-form-item label="ËØ¶ÁªÜÂú∞ÂùÄ" :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•ËØ¶ÁªÜÂú∞ÂùÄ', trigger: 'blur' }]">
                                        <el-input v-model="addressForm.detailAddress"></el-input>
                                    </el-form-item>
                                    <el-form-item label="ÈÇÆÊîøÁºñÁ†Å">
                                        <el-input v-model="addressForm.zipCode"></el-input>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-checkbox v-model="addressForm.isDefault">ËÆæ‰∏∫ÈªòËÆ§Âú∞ÂùÄ</el-checkbox>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <el-button @click="dialogVisible = false">ÂèñÊ∂à</el-button>
                                    <el-button type="primary" @click="submitAddress">Á°ÆÂÆö</el-button>
                                </template>
                            </el-dialog>
                        </div>
                        <div v-if="isUserDetailPage">
                            <!-- Áî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØ -->
                            <el-descriptions
                                    title="üìñÁî®Êà∑ËØ¶ÁªÜ"
                                    direction="vertical"
                                    border
                            >
                                <template #extra>
                                    <el-button type="primary" @click="editUserInfo">ÁºñËæë</el-button>
                                </template>
                                <el-descriptions-item
                                        :rowspan="3"
                                        :width="140"
                                        label="Â§¥ÂÉè"
                                        align="center"
                                >
                                    <div>
                                        <img title="detail-avatar" v-if="loginedUserData.avatar" :src="`/MFile/download?id=${loginedUserData.avatar}`" style="width: 100px; height: 100px" />
                                        <el-icon v-else><Plus /></el-icon>
                                    </div>
                                </el-descriptions-item>
                                <el-descriptions-item label="Áî®Êà∑ID">{{loginedUserData.id}}</el-descriptions-item>
                                <el-descriptions-item label="Áî®Êà∑Ë¥¶Âè∑">{{loginedUserData.code}}</el-descriptions-item>
                                <el-descriptions-item label="Áî®Êà∑Âêç">{{loginedUserData.name}}</el-descriptions-item>
                                <el-descriptions-item label="ÊÄßÂà´">{{loginedUserData.gender}}</el-descriptions-item>
                                <el-descriptions-item label="ÂüéÂ∏Ç">{{loginedUserData.cityName}}</el-descriptions-item>
                                <el-descriptions-item label="‰ºöÂëòÁ≠âÁ∫ß">{{loginedUserData.levelId}}</el-descriptions-item>
                            </el-descriptions>
                        </div>
                        <div v-if="isShoppingPage">
                            <!-- Ë¥≠Áâ©ËΩ¶ -->
                            <div class="title-content">
                                <h2>Ë¥≠Áâ©ËΩ¶</h2>
                                <div>
                                    <sub>ÂêàËÆ°:&nbsp;</sub><span class="final-buy-price">Ôø•{{finalBuyPrice}}</span>
                                    <el-button type="danger" @click="confirmBuy" >ÁªìÁÆó</el-button>
                                </div>
                            </div>
                            <div class="shopping-card-content" style="height: 100vh; overflow-y: scroll">
                                <template v-for="item in userShoppingCarts" :key="item.cartId">
                                    <el-card style="width: 960px; height: 200px; margin: 15px 0" shadow="hover">
                                        <div class="shopping-card-item">
                                            <div class="shopping-card-image">
                                                <input type="checkbox" class="shopping-card-checkbox"  v-model="item.isSelected" @change="calculateTotal"/>
                                                <img title="shopping-card-img"
                                                     :src="`/MFile/download?id=${item.mainImage}`"
                                                     class="shopping-card-img"
                                                />
                                                <div class="card-goods-item">
                                                    <div>
                                                        <h1 class="card-goods-name">{{item.spuName}}</h1>
                                                        <span v-for=" spec in item.specs" class="selected-spec"> {{ spec }}</span>
                                                    </div>
                                                    <div class="card-goods-floor">
                                                        <h1 class="card-goods-price">Ôø•{{item.totalPrice}}</h1>
                                                        <el-input-number v-model="item.quantity" :min="1" label="Ë¥≠‰π∞Êï∞Èáè" @change="calculateTotal"></el-input-number>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="deleteBtu">
                                                <el-button type="danger" @click="deleteShoppingCart(item.cartId)">ÂèñÊ∂àË¥≠‰π∞</el-button>
                                            </div>
                                        </div>

                                    </el-card>
                                </template>
                            </div>
                        </div>
                        <div v-if="isOrderPage">
                            <!-- ËÆ¢Âçï -->
                            <h2>ËÆ¢Âçï</h2>
                            <div class="order-card" style="height: 100vh; overflow-y: scroll">
                                <template v-for="item in userOrderInfo" :key="item.orderId">
                                    <el-card style="width: 960px; margin: 15px 0" shadow="hover" @click="onOrderDetail(item)">
                                        <template #header>
                                            <div class="order-card-header">
                                                <h3>{{item.merchantName}}</h3>
                                                <span>{{item.orderStatus}}</span>
                                            </div>
                                        </template>
                                        <template v-for="buyProduct in item.buyProducts" :key="buyProduct">
                                            <div class="order-card-item">
                                                <div class="order-card-image">
                                                    <img title="order-card-img"
                                                         :src="`/MFile/download?id=${buyProduct.mainImage}`"
                                                         class="order-card-img"
                                                    />
                                                    <div class="order-goods-detail-item">
                                                        <div>
                                                            <h1 class="card-goods-name">{{buyProduct.spuName}}</h1>
                                                            <span v-for=" spec in buyProduct.specs" class="selected-spec"> {{ spec }}</span>
                                                            <h3 class="order-goods-util-price">Ôø•{{buyProduct.unitPrice}}</h3>
                                                        </div>
                                                        <div>
                                                            <span class="order-goods-quantity">√ó{{buyProduct.quantity}}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                        <template #footer>
                                            <div class="delivery-info">
                                                <span class="delivery-method">ÈÖçÈÄÅÊñπÂºè&nbsp;{{item.deliveryMethod}}</span>
                                                <span class="delivery-fee">Âø´ÈÄí&nbsp;{{item.deliveryFee}}ÂÖÉ</span>
                                            </div>
                                            <div class="order-card-footer">
                                                <span class="order-total-quantity">ÂÖ±{{item.totalQuantity}}‰ª∂ÔºåÂ∞èËÆ°Ôø•</span>
                                                <h3 class="order-total-price">{{item.orderAmount}}</h3>
                                            </div>
                                        </template>
                                    </el-card>
                                </template>
                            </div>
                            <template v-if="isCheckOrderDetail">
                                <el-dialog v-model="isCheckOrderDetail" width="500" style="">
                                    <div class="order-detail-dialog">
                                        <div class="order-detail-dialog-header">
                                            <div>
                                                <span class="user-receiver">{{OrderDetailInfo.receiver}}&nbsp;&nbsp;</span>
                                                <span class="user-telephone">{{OrderDetailInfo.telephone}}</span>
                                            </div>
                                            <div>
                                                <h3 class="user-address">{{OrderDetailInfo.detailAddress}}</h3>
                                            </div>
                                        </div>
                                        <div class="order-detail-dialog-body">
                                            <template v-for="buyProduct in OrderDetailInfo.buyProducts" :key="buyProduct">
                                                <div class="order-card-item">
                                                    <div class="order-card-image">
                                                        <img title="order-card-img"
                                                             :src="`/MFile/download?id=${buyProduct.mainImage}`"
                                                             class="order-card-img"
                                                        />
                                                        <div class="order-goods-detail-item">
                                                            <div>
                                                                <h1 class="card-goods-name">{{buyProduct.spuName}}</h1>
                                                                <span v-for=" spec in buyProduct.specs" class="selected-spec"> {{ spec }}</span>
                                                                <h3 class="order-goods-util-price">Ôø•{{buyProduct.unitPrice}}</h3>
                                                            </div>
                                                            <div>
                                                                <span class="order-goods-quantity">√ó{{buyProduct.quantity}}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            <div class="delivery-info">
                                                <span class="delivery-method">ÈÖçÈÄÅÊñπÂºè&nbsp;{{OrderDetailInfo.deliveryMethod}}</span>
                                                <span class="delivery-fee">Âø´ÈÄí&nbsp;{{OrderDetailInfo.deliveryFee}}ÂÖÉ</span>
                                            </div>
                                            <div class="order-card-footer">
                                                <span class="order-total-quantity">ÂÖ±{{OrderDetailInfo.totalQuantity}}‰ª∂ÔºåÂ∞èËÆ°Ôø•</span>
                                                <h3 class="order-total-price">{{OrderDetailInfo.orderAmount}}</h3>
                                            </div>
                                        </div>
                                        <div class="order-detail-dialog-footer">
                                            <h3 class="title">ËÆ¢Âçï‰ø°ÊÅØ</h3>
                                            <div class="order-detail-dialog-footer-time">
                                                <div class="time">
                                                    <span>ËÆ¢ÂçïÁºñÂè∑</span>
                                                    <span>{{OrderDetailInfo.orderId}}</span>
                                                </div>
                                                <div class="time">
                                                    <span>ÊîØ‰ªò‰∫§ÊòìÂè∑</span>
                                                    <span>{{OrderDetailInfo.tradeNo}}</span>
                                                </div>
                                                <div class="time">
                                                    <span>ÂàõÂª∫Êó∂Èó¥</span>
                                                    <span>{{OrderDetailInfo.createTime}}</span>
                                                </div>
                                                <div class="time">
                                                    <span>‰ªòÊ¨æÊó∂Èó¥</span>
                                                    <span>{{OrderDetailInfo.payTime}}</span>
                                                </div>
                                                <div class="time">
                                                    <span>ÂèëË¥ßÊó∂Èó¥</span>
                                                    <span>{{OrderDetailInfo.shipTime}}</span>
                                                </div>
                                                <div class="time">
                                                    <span>Êî∂Ë¥ßÊó∂Èó¥</span>
                                                    <span>{{OrderDetailInfo.receiveTime}}</span>
                                                </div>
                                                <div class="time">
                                                    <span>ÂÆåÊàêÊó∂Èó¥</span>
                                                    <span>{{OrderDetailInfo.completeTime}}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </el-dialog>
                            </template>

                        </div>
                        <div v-if="isSettingPage">
                            <!-- ËÆæÁΩÆ -->
                            <h2>ËÆæÁΩÆ</h2>
                            <div class="setting-content">
                                <el-popconfirm title="‰Ω†Á°ÆÂÆöÊ≥®ÈîÄË¥¶Êà∑Ôºü" placement="bottom-start" @confirm="deleteAccount">
                                    <template #reference>
                                        <el-button type="danger" >Ê≥®ÈîÄË¥¶Âè∑</el-button>
                                    </template>
                                </el-popconfirm>
                                <el-button type="primary" @click="editPassword">Êõ¥ÊîπÂØÜÁ†Å</el-button>
                            </div>
                        </div>
                    </el-main>
                </el-container>
            </el-container>
        </div>
    </div>
    <template v-if="isEdit" class="editDialog">
        <el-dialog v-model="showDialog" :title="isEdit ? 'ÁºñËæë' : ''" width="400">
            <el-form ref="editForm" :model="editForm" :rules="rules" label-width="auto">
                <el-form-item label="Â§¥ÂÉè" prop="avatar">
                    <el-upload :show-MFile-list="false" :before-upload="uploadAvatar"  >
                        <img title="editAvatar" v-if="editForm.avatar" :src="`/MFile/download?id=${editForm.avatar}`" style="width: 100px; height: 100px" />
                        <el-icon v-else><Plus></Plus></el-icon>
                    </el-upload>
                </el-form-item>
                <el-form-item label="ÂêçÁß∞" prop="name">
                    <el-input v-model="editForm.name" maxlength="20" />
                </el-form-item>
                <el-form-item label="Ê≥®ÂÜåÂüéÂ∏Ç" prop="city">
                    <el-cascader v-model="editForm.city" :options="districts" :show-all-levels="true" placeholder="ËØ∑ÈÄâÊã©Âú∞ÂùÄ" clearable />
                </el-form-item>
                <el-form-item label="ÊÄßÂà´" prop="gender">
                    <el-radio-group v-model="editForm.gender">
                        <el-radio :value="'Áî∑'">Áî∑</el-radio>
                        <el-radio :value="'Â•≥'">Â•≥</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary"  @click="onSubmit">Á°ÆÂÆö</el-button>
            </template>
        </el-dialog>
    </template>
    <template v-if="isEditPassword" class="editPasswordDialog">
        <el-dialog v-model="showDialogPassword" :title="isEdit ? 'ÁºñËæë' : ''" width="400">
            <el-form ref="editForm" :model="editForm" :rules="rules" label-width="auto">
                <el-form-item label="ÊóßÂØÜÁ†Å" prop="password" >
                    <el-input v-model="editForm.password" maxlength="20" type="password"/>
                </el-form-item>
                <el-form-item label="Êñ∞ÂØÜÁ†Å" prop="password" >
                    <el-input v-model="editForm.newPassword" maxlength="20"  type='password' />
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showDialogPassword = false">ÂèñÊ∂à</el-button>
                <el-button type="primary"  @click="onSubmitPassword">Á°ÆÂÆö</el-button>
            </template>
        </el-dialog>
    </template>
</div>
<script>
    const app =  Vue.createApp({
        data(){
            return{
                isAddressPage: false, // Âú∞ÂùÄÁÆ°ÁêÜÈ°µÈù¢ÊòæÁ§∫ÊéßÂà∂
                addressList: [],      // Âú∞ÂùÄÂàóË°®Êï∞ÊçÆ
                total: 0,             // Âú∞ÂùÄÊÄªÊï∞
                currentPage: 1,       // ÂΩìÂâçÈ°µÁ†Å
                pageSize: 10,         // ÊØèÈ°µÊù°Êï∞
                dialogVisible: false, // Êñ∞Â¢û/ÁºñËæëÂºπÁ™óÊòæÁ§∫
                isEdit: false,        // ÊòØÂê¶Ê≠£Âú®ÁºñËæë
                addressForm: {        // Âú∞ÂùÄË°®ÂçïÁöÑÊï∞ÊçÆ
                    addressId: '',
                    userId: '',
                    receiver: '',
                    telephone: '',
                    detailAddress: '',
                    zipCode: '',
                    isDefault: false
                },
                OrderDetailInfo:{},
                isCheckOrderDetail: false,
                finalBuyPrice:'0.00',
                userOrderInfo:[],
                userShoppingCarts:[],
                isEditPassword:false,
                showDialogPassword:false,
                districts: [],
                isEdit:false,
                isUserDetailPage:true,
                isShoppingPage:false,
                isOrderPage:false,
                isSettingPage:false,
                itemNumber:'',
                urlItemNumber: null,
                cartGoodsBugNumber:1,
                loginedUserData:{
                    id:'',
                    code:'',
                    name:'',
                    gender:'',
                    avatar:'',
                    city:'',
                    levelId:'',
                    createTime: '',
                    cityName:'',
                },
                showDialog:false,
                editForm: {
                    id:'',
                    name: '',
                    city: '',
                    gender: '',
                    avatar: '',
                    password:'',
                    newPassword:''
                },
                rules: {
                    name: [{required: true, message: 'ËØ∑ËæìÂÖ•ÂêçÁß∞'}],
                    password: [{required: true, message: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å'},
                        {
                            validator(rule, value, callback) {
                                if (value) {
                                    if (/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z\W]{6,18}$/.test(value)) {
                                        callback();
                                    } else {
                                        callback(new Error('ËØ∑ËæìÂÖ•ÂåÖÂê´Ëã±ÊñáÂíåÊï∞Â≠óÔºåÂú®6-18‰Ωç‰πãÈó¥'))
                                    }
                                } else {
                                    callback();
                                }
                            },
                            trigger: 'blur'
                        }
                    ],
                },
                addressColumns: [
                    { type: 'seq', width: 60 },
                    { field: 'addressId', title: 'Âú∞ÂùÄID' },
                    { field: 'receiver', title: 'Êî∂‰ª∂‰∫∫' },
                    { field: 'telephone', title: 'ÁîµËØù' },
                    { field: 'detailAddress', title: 'ËØ¶ÁªÜÂú∞ÂùÄ' },
                    { field: 'zipCode', title: 'ÈÇÆÊîøÁºñÁ†Å' },
                    {
                        field: 'isDefault',
                        title: 'ÈªòËÆ§Âú∞ÂùÄ',
                        formatter: ({ cellValue }) => cellValue ? '‚úî' : '‚ùå'
                    },
                    {
                        field: 'operate',
                        title: 'Êìç‰Ωú',
                        width: 160,
                        slots: { default: 'default' } // ÂÖ≥ËÅîËá™ÂÆö‰πâÊìç‰ΩúÊåâÈíÆ
                    }
                ]
            }
        },
        async created(){
            this.getUserInfo();
            await this.initDistricts();
            this.activateDefaultItem();
            this.initDistricts();
        },
        methods:{
            // ÂàÜÈ°µÂàáÊç¢
            handlePageChange(val) {
                this.currentPage = val;
                this.getAddressList();
            },
            // ÊòæÁ§∫Êñ∞Â¢ûÂºπÁ™ó
            showAddDialog() {
                this.isEdit = false;
                this.addressForm = {
                    userId: this.loginedUserData.id,
                    receiver: '',
                    telephone: '',
                    detailAddress: '',
                    zipCode: '',
                    isDefault: false
                };
                this.dialogVisible = true;
            },
            // ÁºñËæëÂú∞ÂùÄ
            handleEdit(row) {
                this.isEdit = true;
                this.addressForm = { ...row };
                this.dialogVisible = true;
            },
            // Âà†Èô§Âú∞ÂùÄ
            async handleDelete(addressId) {
                await axios.post('/address/delete', {addressId}).then(res => {
                }).catch(error => {
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                });
                await this.getAddressList();
            },
            // Êèê‰∫§Âú∞ÂùÄÔºàÊñ∞Â¢û/ÁºñËæëÔºâ
            submitAddress() {
                debugger;
                this.addressForm.userId = this.loginedUserData.id; // Á°Æ‰øùÊòØÊï∞Â≠ó
                axios.post('/address/saveOrUpdate', this.addressForm)
                    .then(() => {
                        this.$message.success(this.isEdit ? '‰øÆÊîπÊàêÂäü' : 'Êñ∞Â¢ûÊàêÂäü');
                        this.dialogVisible = false;
                        this.getAddressList();
                    }).catch(error => {
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                });
            },
            toAddressManage() {
                // ÂàáÊç¢Âà∞Âú∞ÂùÄÁÆ°ÁêÜÈ°µÈù¢
                this.isUserDetailPage = false;
                this.isShoppingPage = false;
                this.isOrderPage = false;
                this.isSettingPage = false;
                this.isAddressPage = true;
                this.updateUrlItemNumber('5'); // Êõ¥Êñ∞URLÂèÇÊï∞
                this.getAddressList(); // Âä†ËΩΩÂú∞ÂùÄÂàóË°®
            },
            // Ëé∑ÂèñÂú∞ÂùÄÂàóË°®ÔºàÂàÜÈ°µÔºâ
            getAddressList() {
                // Ê£ÄÊü•Áî®Êà∑IDÊòØÂê¶Â≠òÂú®
                if (!this.loginedUserData.id) {
                    this.$message.error('ËØ∑ÂÖàÁôªÂΩï');
                    return;
                }
                axios.post('/address/getAll', {
                    id: String(this.loginedUserData.id), // ËΩ¨Â≠óÁ¨¶‰∏≤
                    current: this.currentPage,
                    size: this.pageSize
                }).then(response => {
                    this.addressList = response.data.records || [];
                    this.total = response.data.total || 0;
                }).catch(error => {
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                });
            },
            onOrderDetail(item){
                this.isCheckOrderDetail = true;
                this.OrderDetailInfo = item;
                console.log(item);
            },
            backStore(){
                window.location.href = 'http://localhost:8080/foodMap';
            },
            deleteShoppingCart(cartId){
                axios.post('http://localhost:8080/shoppingCart/deleteShoppingCart', {
                    cartId: cartId,
                }).then((res) => {
                    if (res.status === 200) {
                        this.$message({
                            message:'ÂèñÊ∂àÊàêÂäü',
                            type: 'success'
                        });
                        this.toShoppingCart();
                    }else {
                        this.$message({
                            message:'ÂèñÊ∂àÂ§±Ë¥•',
                            type: 'error'
                        })
                    }
                }).catch((error) => {
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })
            },
            calculateCartItemsPrice() {
                this.userShoppingCarts.forEach(item => {
                    // ËÆ°ÁÆóËßÑÊ†º‰ª∑Ê†ºÊÄªÂíå
                    item.totalPrice = parseFloat(item.unitPrice * (item.quantity || 1).toFixed(2));
                    return item.totalPrice;
                });
            },
            uploadAvatar(f) {
                const response = axios.post('/MFile/upload', {MFile: f}, {
                    headers: {'Content-Type': 'multipart/form-data'}
                }).then((res) => {
                    if(res.status === 200){
                        this.editForm.avatar = res.data.id;
                        return false;
                    }
                }).catch((error) =>{
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })
            },
            deleteAccount(){
                axios.post('http://localhost:8080/user/logout').then(response =>{
                    if(response.status === 200){
                        this.$message({
                            message: 'Ê≥®ÈîÄÊàêÂäü',
                            type: 'success'
                        });
                        // ËøîÂõûÂïÜÂüéÈ°µ
                        this.backStore();
                    }else{
                        this.$message({
                            message: 'Ê≥®ÈîÄÂ§±Ë¥•',
                            type: 'warning'
                        });
                    }
                }).catch((error) =>{
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })
            },
            editPassword(){
                this.isEditPassword = true;
                this.showDialogPassword = true;
            },
            onSubmitPassword(){
                if(this.editForm.newPassword == null && this.editForm.password == null){
                    this.$message({
                        message:'ÂØÜÁ†Å‰∏çËÉΩ‰∏∫Á©∫',
                        type: 'warning'
                    });
                    return false;
                }
                axios.post('http://localhost:8080/user/editPassword',{
                    oldPassword:this.editForm.password.trim(),
                    newPassword:this.editForm.newPassword.trim()
                }).then(response =>{
                    if(response.status === 200){
                        this.$message({
                            message: '‰øÆÊîπÂØÜÁ†ÅÊàêÂäü',
                            type: 'success'
                        });
                        this.showDialogPassword = false;
                        this.editForm = {};
                    }else{
                        this.$message({
                            message: '‰øÆÊîπÂØÜÁ†ÅÂ§±Ë¥•',
                            type: 'warning'
                        });
                    }
                }).catch((error) =>{
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })
            },
            // Ê†πÊçÆÂú∞Âå∫ÁºñÁ†ÅËé∑ÂèñÂú∞Âå∫ÂêçÁß∞
            getFullRegionPath(districts, districtCode) {
                //  Êü•ÊâæÁõÆÊ†áËäÇÁÇπÂπ∂ËÆ∞ÂΩïË∑ØÂæÑ
                const findPath = (nodes, code, path = []) => {
                    for (const node of nodes) {
                        // Ê£ÄÊü•ÂΩìÂâçËäÇÁÇπ
                        if (node.value === code) {
                            return [...path, node.label];
                        }

                        // ÈÄíÂΩíÊ£ÄÊü•Â≠êËäÇÁÇπ
                        if (node.children && node.children.length) {
                            const found = findPath(
                                node.children,
                                code,
                                [...path, node.label]  // Ê∑ªÂä†ÂΩìÂâçËäÇÁÇπÂà∞Ë∑ØÂæÑ
                            );
                            if (found) return found;
                        }
                    }
                    return null;
                };
                const path = findPath(districts, districtCode);
                return path ? path.join(' ') : '';
            },
            updateCityName() {
                if (this.loginedUserData.city != null) {
                    this.loginedUserData.cityName = this.getFullRegionPath(this.districts,this.loginedUserData.city);
                } else {
                    this.detailForm.cityName = '';
                }
            },
            //Ëß£ÊûêurlÂèÇÊï∞
            parseUrlParams() {
                const query = window.location.search.substring(1);
                const params = {};
                query.split('&').forEach(pair => {
                    const [key, value] = pair.split('=');
                    params[key] = decodeURIComponent(value);
                });
                return params;
            },
            //Ê†πÊçÆÈÄâÊã©ÊøÄÂåñËèúÂçï
            activateDefaultItem() {
                const params = this.parseUrlParams();
                if(params.itemNumber) {
                    this.urlItemNumber = params.itemNumber;
                    // Ê†πÊçÆitemNumberÊøÄÊ¥ªËèúÂçï
                    this.itemNumber = params.itemNumber;
                    switch(params.itemNumber) {
                        case '1':
                            this.toUserDetail();
                            break;
                        case '2':
                            this.toShoppingCart();
                            break;
                        case '3':
                            this.toOrder();
                            break;
                        case '4':
                            this.toSetting();
                            break;
                        default:
                            this.toUserDetail();
                    }
                } else {
                    // ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜ‰ø°ÊÅØ
                    this.toUserDetail();
                }
            },
            //Êõ¥Êñ∞ÂèÇÊï∞
            updateUrlItemNumber(number) {
                const url = new URL(window.location);
                url.searchParams.set('itemNumber', number);
                window.history.replaceState(null, null, url.toString());
            },
            toUserDetail(){
                this.isUserDetailPage = true;
                this.isOrderPage = false;
                this.isShoppingPage = false;
                this.isSettingPage = false;
                this.updateUrlItemNumber('1')
                this.getUserInfo();
                console.log('Áî®Êà∑ËØ¶ÁªÜ')
            },
            toShoppingCart(){
                this.isUserDetailPage = false;
                this.isOrderPage = false;
                this.isShoppingPage = true;
                this.isSettingPage = false;
                axios.post('http://localhost:8080/shoppingCart/getShoppingCartById'
                ).then(response =>{
                    if(response.status === 200 || response.data() !== null){
                        this.$message({
                            message:'Ëé∑ÂèñË¥≠Áâ©ËΩ¶ÊàêÂäü',
                            type: 'success'
                        })
                        this.userShoppingCarts = response.data;
                        this.calculateCartItemsPrice();
                    }else {
                        this.$message({
                            message:'Ëé∑ÂèñË¥≠Áâ©ËΩ¶Â§±Ë¥•',
                            type: 'warning'
                        })
                    }
                }).catch((error) =>{
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })
                this.updateUrlItemNumber('2');
                console.log('Ë¥≠Áâ©ËΩ¶');
            },
            toOrder(){
                this.isUserDetailPage = false;
                this.isOrderPage = true;
                this.isShoppingPage = false;
                this.isSettingPage = false;
                this.updateUrlItemNumber('3');
                axios.post('http://localhost:8080/order/getOrders'
                ).then(response =>{
                    if(response.status === 200 || response.data() !== null){
                        this.$message({
                            message:'Ëé∑ÂèñËÆ¢ÂçïÊàêÂäü',
                            type: 'success'
                        })
                        this.userOrderInfo = response.data;
                    }else {
                        this.$message({
                            message:'Ëé∑ÂèñËÆ¢ÂçïÂ§±Ë¥•',
                            type: 'warning'
                        })
                    }
                }).catch((error) =>{
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })
                console.log('ËÆ¢Âçï')
            },
            toSetting(){
                this.isUserDetailPage = false;
                this.isOrderPage = false;
                this.isShoppingPage = false;
                this.isSettingPage = true;
                this.updateUrlItemNumber('4');
                console.log('ËÆæÁΩÆ')
            },
            async initDistricts() {
                const response = await axios.post('http://localhost:8080/user/initDistricts');
                // ËΩ¨Êç¢ÊâÄÊúâvalue‰∏∫Â≠óÁ¨¶‰∏≤
                const convertValues = (nodes) => {
                    return nodes.map(node => ({
                        ...node,
                        value: String(node.value),
                        children: node.children ? convertValues(node.children) : []
                    }));
                };

                this.districts = convertValues(response.data);
                console.log(this.districts);
            },
            getUserInfo(){
                axios.post('http://localhost:8080/user/getUserInfo',
                ).then(response => {
                    if (response.status === 200) {
                        this.$message({
                            message: 'Ëé∑ÂèñÁî®Êà∑ÊàêÂäü',
                            type: 'success'
                        });
                        this.loginedUserData = response.data;
                        this.updateCityName();
                    } else {
                        this.$message({
                            message: 'Ëé∑ÂèñÁî®Êà∑Â§±Ë¥•',
                            type: 'warning'
                        });
                        console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö', response.status);
                    }
                }).catch(err => {
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + err.response.data.code + ', Ê∂àÊÅØ:' + err.response.data.msg + ', Êó∂Èó¥:' + err.response.data.time+'}',
                        type: 'error'
                    });
                });
            },
            editUserInfo(){
                this.showDialog = true;
                this.isEdit = true;
                // this.editForm = {
                //     id: this.loginedUserData.id,
                //     name: this.loginedUserData.name,
                //     city: this.loginedUserData.city,
                //     avatar: this.loginedUserData.avatar,
                //     gender: this.loginedUserData.gender,
                // };
                this.editForm = {...this.loginedUserData}
            },

            onSubmit(){
                if (Array.isArray(this.editForm.city)) {
                    this.editForm.city = Number(this.editForm.city[this.editForm.city.length - 1]); // ËΩ¨Êç¢‰∏∫Êï∞Â≠ó
                }
                if (this.editForm.gender === '' || this.editForm.name === '') {
                    this.$message({
                        message:'ËØ∑ÂÆåÊàêÂÖàË°•ÂÖ®ÊÄßÂà´ÂíåÂßìÂêç',
                        type: 'warning'
                    });
                    return false;
                }
                axios.post('http://localhost:8080/user/edit',
                    this.editForm
                ).then(response=>{
                    if(response.status === 200){
                        this.getUserInfo();
                        this.showDialog = false;
                        this.isEdit = false;
                    }
                }).catch((error) =>{
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })
            },
            calculateTotal() {
                this.calculateCartItemsPrice();
                let total = 0;
                this.userShoppingCarts.forEach(item => {
                    if (item.isSelected) {
                        const sum =  item.unitPrice * (item.quantity || 1);
                        total += sum;
                        // ËÆ°ÁÆóËßÑÊ†º‰ª∑Ê†ºÊÄªÂíå
                        item.totalPrice = parseFloat(sum).toFixed(2);

                    }
                });
                this.finalBuyPrice = parseFloat(total).toFixed(2);
            },

            // ÁªìÁÆóÊåâÈíÆÂ§ÑÁêÜ
            confirmBuy() {
                const cartItems = this.userShoppingCarts.filter(item => item.isSelected);
                this.userShoppingCarts = this.userShoppingCarts.filter(item => !item.isSelected);
                if (cartItems.length === 0) {
                    this.$message.warning('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰ª∂ÂïÜÂìÅËøõË°åÁªìÁÆó');
                    return false;
                }

                console.log('ÁªìÁÆóÁöÑÂïÜÂìÅ:', cartItems);
                console.log('ÊÄªÈáëÈ¢ù:', this.finalBuyPrice);
                axios.post('http://localhost:8080/order/buyByCart',{
                    cartItems
                }).then(response => {
                    if (response.status === 200 && response.data === true) {
                        this.$message.success(`ÁªìÁÆóÊàêÂäüÔºÅÊÄªÈáëÈ¢ùÔºö¬•${this.finalBuyPrice}`);
                        this.toShoppingCart();
                        this.calculateTotal();
                    }
                }).catch(error => {
                    this.$message({
                        message: 'ÂºÇÂ∏∏:{Áä∂ÊÄÅ:' + error.response.data.code +', Ê∂àÊÅØ:' + error.response.data.msg + ', Êó∂Èó¥:' + error.response.data.time+'}',
                        type: 'error'
                    });
                    console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error.response.data);
                })

            }
        },

        watch: {
        },
        computed: {

        }

    });
    for ([name, comp] of Object.entries(ElementPlusIconsVue)) {
        app.component(name, comp);
    }
    app.use(ElementPlus).use(VxeUITable).mount('#app');
</script>
</body>
</html>