<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Áî®Êà∑ÁöÑËØ¶ÊÉÖ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/static_resources/element-plus-index.css" />
    <link rel="stylesheet" href="/static_resources/vxe-table-style.css">
    <script src="/static_resources/vue.global.js"></script>
    <script src="/static_resources/element-plus-index.full.js"></script>
    <script src="/static_resources/xe-utils.js"></script>
    <script src="/static_resources/vxe-table@4.6.25.js"></script>
    <script src="/static_resources/axios.min.js"></script>
    <script src="/static_resources/element-plus_icons-vue.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon_logosc/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon_logosc/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon_logosc/favicon-16x16.png">
    <link rel="manifest" href="/favicon_logosc/site.webmanifest">
    <link rel="stylesheet" href="./static_resources/userDetail.css" />
</head>
<body>
    <div id="app">
        <div class="top-nav">
            <div class="container">
                <div class="content">
                    <h2>ÁæéÈ£üÂú∞ÂõæÊ¨¢Ëøé‰Ω†</h2>
                    <el-button type="primary" @click="backStore">ËøîÂõû</el-button>
                </div>
            </div>
        </div>
        <div class="container" >
            <div class="common-layout">
                <el-container>
                    <el-header>
                        <div class="header">
                            <el-avatar v-if="loginedUSerData.avatar" :size="50" :src="`http://localhost:8080/MFile/download?id=${loginedUSerData.avatar}`" ></el-avatar>
                            <el-avatar v-else :size="50" ><Plus /></el-avatar>
                            <h3 v-if="loginedUSerData.name">{{loginedUSerData.name}}</h3>
                            <h3 v-else>Áî®Êà∑Âêç</h3>
                        </div>
                    </el-header>
                <el-container>
                    <el-aside width="200px">
                        <el-menu
                          v-model:default-active="itemNumber"
                          class="el-menu-vertical-demo"
                        >
                            <el-menu-item index="1" @click="toUserDetail">
                            <el-icon><document /></el-icon>
                            <span>ËØ¶ÁªÜ‰ø°ÊÅØ</span>
                            </el-menu-item>
                            <el-menu-item index="2" @click="toShoppingCart">
                            <el-icon><document /></el-icon>
                            <span>Ë¥≠Áâ©ËΩ¶</span>
                            </el-menu-item>
                            <el-menu-item index="3" @click="toOrder">
                            <el-icon><document /></el-icon>
                            <span>ÊàëÁöÑËÆ¢Âçï</span>
                            </el-menu-item>
                            <el-menu-item index="4" @click="toSetting">
                            <el-icon><setting /></el-icon>
                            <span>ËÆæÁΩÆ</span>
                            </el-menu-item>
                        </el-menu>
                    </el-aside>
                    <el-main>
                        <div v-if="isUserDetailPage">
                            <!-- Áî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØ -->
                            <el-descriptions
                                title="üìñÁî®Êà∑ËØ¶ÁªÜ"
                                direction="vertical"
                                border
                            >
                                <template #extra>
                                    <el-button type="primary" @click="editUserInfo">ÁºñËæë</el-button>
                                </template>
                                <el-descriptions-item
                                        :rowspan="3"
                                        :width="140"
                                        label="Â§¥ÂÉè"
                                        align="center"
                                >
                                    <div>
                                        <img title="detail-avatar" v-if="loginedUSerData.avatar" :src="`/MFile/download?id=${loginedUSerData.avatar}`" style="width: 100px; height: 100px" />
                                        <el-icon v-else><Plus /></el-icon>
                                    </div>
                                </el-descriptions-item>
                                <el-descriptions-item label="Áî®Êà∑ID">{{loginedUSerData.id}}</el-descriptions-item>
                                <el-descriptions-item label="Áî®Êà∑Ë¥¶Âè∑">{{loginedUSerData.code}}</el-descriptions-item>
                                <el-descriptions-item label="Áî®Êà∑Âêç">{{loginedUSerData.code}}</el-descriptions-item>
                                <el-descriptions-item label="ÊÄßÂà´">{{loginedUSerData.gender}}</el-descriptions-item>
                                <el-descriptions-item label="ÂüéÂ∏Ç">{{loginedUSerData.city}}</el-descriptions-item>
                                <el-descriptions-item label="‰ºöÂëòÁ≠âÁ∫ß">{{loginedUSerData.levelId}}</el-descriptions-item>
                            </el-descriptions>
                        </div>
                        <div v-if="isShoppingPage">
                            <!-- Ë¥≠Áâ©ËΩ¶ -->
                            <div class="title-content">
                                <h2>Ë¥≠Áâ©ËΩ¶</h2>
                                <div>
                                    <sub>ÂêàËÆ°:&nbsp;</sub><span class="final-buy-price">Ôø•{{finalBuyPrice}}</span>
                                    <el-button type="danger" @click="confirmBuy" >ÁªìÁÆó</el-button>
                                </div>
                            </div>
                            <div class="shopping-card-content">
                                <template v-for="item in userShoppingCarts" :key="item.cartId">
                                    <el-card style="width: 960px; height: 200px; margin: 15px 0" shadow="hover">
                                        <div class="shopping-card-item">
                                            <div class="shopping-card-image">
                                                <input type="checkbox" class="shopping-card-checkbox"  v-model="item.isSelected" @change="calculateTotal"/>
                                                <img title="shopping-card-img"
                                                :src="`/MFile/download?id=${item.mainImage}`"
                                                class="shopping-card-img"
                                                />
                                                <div class="card-goods-item">
                                                    <div>
                                                        <h1 class="card-goods-name">{{item.spuName}}</h1>
                                                        <span v-for="(price, spec) in item.specsPrice" class="selected-spec"> {{ spec }}</span>
                                                    </div>
                                                    <div class="card-goods-floor">
                                                        <h1 class="card-goods-price">Ôø•{{item.totalPrice}}</h1>
                                                        <el-input-number v-model="item.quantity" :min="1" label="Ë¥≠‰π∞Êï∞Èáè" @change="calculateTotal"></el-input-number>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="deleteBtu">
                                                <el-button type="danger" @click="deleteShoppingCart(item.cartId)">ÂèñÊ∂àË¥≠‰π∞</el-button>
                                            </div>
                                        </div>

                                    </el-card>
                                </template>
                            </div>
                        </div>
                        <div v-if="isOrderPage">
                            <!-- ËÆ¢Âçï -->
                            <h2>ËÆ¢Âçï</h2>
                        </div>
                        <div v-if="isSettingPage">
                            <!-- ËÆæÁΩÆ -->
                            <h2>ËÆæÁΩÆ</h2>
                            <div class="setting-content">
                                <el-popconfirm title="‰Ω†Á°ÆÂÆöÊ≥®ÈîÄË¥¶Êà∑Ôºü" placement="bottom-start" @confirm="deleteAccount">
                                    <template #reference>
                                        <el-button type="danger" >Ê≥®ÈîÄË¥¶Âè∑</el-button>
                                    </template>
                                </el-popconfirm>
                                <el-button type="primary" @click="editPassword">Êõ¥ÊîπÂØÜÁ†Å</el-button>
                            </div>
                        </div>
                    </el-main>
                </el-container>
                </el-container>
            </div> 
        </div> 
        <template v-if="isEdit" class="editDialog">
            <el-dialog v-model="showDialog" :title="isEdit ? 'ÁºñËæë' : ''" width="400">
                <el-form ref="editForm" :model="editForm" :rules="rules" label-width="auto">
                    <el-form-item label="Â§¥ÂÉè" prop="avatar">
                        <el-upload :show-MFile-list="false" :before-upload="uploadAvatar"  >
                            <img title="editAvatar" v-if="editForm.avatar" :src="`/MFile/download?id=${editForm.avatar}`" style="width: 100px; height: 100px" />
                            <el-icon v-else><Plus></Plus></el-icon>
                        </el-upload>
                    </el-form-item>
                    <el-form-item label="ÂêçÁß∞" prop="name">
                        <el-input v-model="editForm.name" maxlength="20" />
                    </el-form-item>
                    <el-form-item label="Ê≥®ÂÜåÂüéÂ∏Ç" prop="city">
                        <el-cascader v-model="editForm.city" :options="districts" :show-all-levels="true" placeholder="ËØ∑ÈÄâÊã©Âú∞ÂùÄ" clearable />
                    </el-form-item>
                    <el-form-item label="ÊÄßÂà´" prop="gender">
                        <el-radio-group v-model="editForm.gender">
                            <el-radio :value="'Áî∑'">Áî∑</el-radio>
                            <el-radio :value="'Â•≥'">Â•≥</el-radio>
                        </el-radio-group>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showDialog = false">ÂèñÊ∂à</el-button>
                    <el-button type="primary"  @click="onSubmit">Á°ÆÂÆö</el-button>
                </template>
            </el-dialog>
        </template>
        <template v-if="isEditPasswrod" class="editPasswordDialog">
            <el-dialog v-model="showDialogPassword" :title="isEdit ? 'ÁºñËæë' : ''" width="400">
                <el-form ref="editForm" :model="editForm" :rules="rules" label-width="auto">
                    <el-form-item label="ÊóßÂØÜÁ†Å" prop="password" >
                        <el-input v-model="editForm.password" maxlength="20" type="password"/>
                    </el-form-item>
                    <el-form-item label="Êñ∞ÂØÜÁ†Å" prop="password" >
                        <el-input v-model="editForm.newPassword" maxlength="20"  type='password' />
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showDialogPassword = false">ÂèñÊ∂à</el-button>
                    <el-button type="primary"  @click="onSubmitPassword">Á°ÆÂÆö</el-button>
                </template>
            </el-dialog>
        </template>     
    </div>
    <script>
        const app =  Vue.createApp({
            data(){
                return{
                    finalBuyPrice:'0.00',
                    userShoppingCarts:[],
                    isEditPasswrod:false,
                    showDialogPassword:false,
                    districts: [],
                    isEdit:false,
                    isUserDetailPage:true,
                    isShoppingPage:false,
                    isOrderPage:false,
                    isSettingPage:false,
                    itemNumber:'',
                    urlItemNumber: null,
                    cartGoodsBugNumber:1,
                    loginedUSerData:{
                        id:'',
                        code:'',
                        name:'',
                        gender:'',
                        avatar:'',
                        city:'',
                        levelId:'',
                        createTime: '',
                    },
                    showDialog:false,
                    editForm: {
                        id:'',
                        name: '',
                        city: '',
                        gender: '',
                        avatar: '',
                        password:'',
                        newPassword:''
                    },
                    rules: {
                        name: [{required: true, message: 'ËØ∑ËæìÂÖ•ÂêçÁß∞'}],
                        password: [{required: true, message: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å'},
                            {
                                validator(rule, value, callback) {
                                    if (value) {
                                        if (/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z\W]{6,18}$/.test(value)) {
                                            callback();
                                        } else {
                                            callback(new Error('ËØ∑ËæìÂÖ•ÂåÖÂê´Ëã±ÊñáÂíåÊï∞Â≠óÔºåÂú®6-18‰Ωç‰πãÈó¥'))
                                        }
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'blur'
                            }
                        ],
                    },


                }
            },
            async created(){
                this.getUserInfo();
                await this.initDistricts();
                this.initItem();
                this.activateDefaultItem();
                // this.getUserInfo();
                this.initDistricts();
            },
            methods:{
                initItem(){

                },
                backStore(){
                    // window.location.href = 'http://localhost:8080/app.html';
                    window.open('http://localhost:8080/app.html','_self');
                },
                deleteShoppingCart(cartId){
                    axios.post('http://localhost:8080/shoppingCart/deleteShoppingCart', {
                        cartId: cartId,
                    }).then((res) => {
                        if (res.status === 200) {
                            this.$message({
                                message:'ÂèñÊ∂àÊàêÂäü',
                                type: 'success'
                            });
                            this.toShoppingCart();
                        }else {
                            this.$message({
                                message:'ÂèñÊ∂àÂ§±Ë¥•',
                                type: 'error'
                            })
                        }
                    }).catch((err) => {
                        this.$message({
                            message:err.message,
                            type: 'error'
                        })
                    })
                },
                calculateCartItemsPrice() {
                    this.userShoppingCarts.forEach(item => {
                        // ËÆ°ÁÆóËßÑÊ†º‰ª∑Ê†ºÊÄªÂíå
                        let unitPrice = 0;
                        if (item.specsPrice && typeof item.specsPrice === 'object') {
                            Object.values(item.specsPrice).forEach(price => {
                                unitPrice += parseFloat(price) || 0;
                            });
                        }

                        item.totalPrice = parseFloat(unitPrice * (item.quantity || 1).toFixed(2));
                    });
                },
                uploadAvatar(f) {
                    const response = axios.post('/MFile/upload', {MFile: f}, {
                        headers: {'Content-Type': 'multipart/form-data'}
                    }).then((res) => {
                        if(res.status === 200){
                            this.editForm.avatar = response.data.id;
                            return false;
                        }
                    }).catch((err) =>{
                        this.$message({
                            message: '‰∏ä‰º†Â§±Ë¥•: ' + err.message,
                            type:'error'
                        })
                    })
                },
                deleteAccount(){
                    axios.post('http://localhost:8080/user/logout').then(response =>{
                        if(response.status === 200){
                            this.$message({
                                message: 'Ê≥®ÈîÄÊàêÂäü',
                                type: 'success'
                            });
                            // ËøîÂõûÂïÜÂüéÈ°µ
                            this.backStore();
                        }else{
                            this.$message({
                                message: 'Ê≥®ÈîÄÂ§±Ë¥•',
                                type: 'warning'
                            });
                        }
                    })
                },
                editPassword(){
                    this.isEditPasswrod = true;
                    this.showDialogPassword = true;
                },
                onSubmitPassword(){
                    if(this.editForm.newPassword == null && this.editForm.password == null){
                       this.$message({
                           message:'ÂØÜÁ†Å‰∏çËÉΩ‰∏∫Á©∫',
                           type: 'warning'
                       });
                       return false;
                    }
                    axios.post('http://localhost:8080/user/editPassword',{
                        oldPassword:this.editForm.password.trim(),
                        newPassword:this.editForm.newPassword.trim()
                    }).then(response =>{
                        if(response.status === 200){
                            this.$message({
                                message: '‰øÆÊîπÂØÜÁ†ÅÊàêÂäü',
                                type: 'success'
                            });
                            this.showDialogPassword = false;
                            this.editForm = {};
                        }else{
                            this.$message({
                                message: '‰øÆÊîπÂØÜÁ†ÅÂ§±Ë¥•',
                                type: 'warning'
                            });
                        }
                    })
                },
                //Ëß£ÊûêurlÂèÇÊï∞
                parseUrlParams() {
                    const query = window.location.search.substring(1);
                    const params = {};
                    query.split('&').forEach(pair => {
                        const [key, value] = pair.split('=');
                        params[key] = decodeURIComponent(value);
                    });
                    return params;
                },
                //Ê†πÊçÆÈÄâÊã©ÊøÄÂåñËèúÂçï
                activateDefaultItem() {
                    const params = this.parseUrlParams();
                    if(params.itemNumber) {
                        this.urlItemNumber = params.itemNumber;
                        // Ê†πÊçÆitemNumberÊøÄÊ¥ªËèúÂçï
                        this.itemNumber = params.itemNumber;
                        switch(params.itemNumber) {
                            case '1':
                                this.toUserDetail();
                                break;
                            case '2':
                                this.toShoppingCart();
                                break;
                            case '3':
                                this.toOrder();
                                break;
                            case '4':
                                this.toSetting();
                                break;
                            default:
                                this.toUserDetail();
                        }
                    } else {
                        // ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜ‰ø°ÊÅØ
                        this.toUserDetail();
                    }
                },
               //Êõ¥Êñ∞ÂèÇÊï∞
                updateUrlItemNumber(number) {
                    const url = new URL(window.location);
                    url.searchParams.set('itemNumber', number);
                    window.history.replaceState(null, null, url.toString());
                },
                toUserDetail(){
                    this.isUserDetailPage = true;
                    this.isOrderPage = false;
                    this.isShoppingPage = false;
                    this.isSettingPage = false;
                    this.updateUrlItemNumber('1')
                    this.getUserInfo();
                    console.log('Áî®Êà∑ËØ¶ÁªÜ')
                },
                toShoppingCart(){
                    this.isUserDetailPage = false;
                    this.isOrderPage = false;
                    this.isShoppingPage = true;
                    this.isSettingPage = false;
                    axios.post('http://localhost:8080/shoppingCart/getShoppingCartById'
                    ).then(response =>{
                        if(response.status === 200 || response.data() !== null){
                            this.$message({
                                message:'Ëé∑ÂèñË¥≠Áâ©ËΩ¶ÊàêÂäü',
                                type: 'success'
                            })
                            this.userShoppingCarts = response.data;
                            this.calculateCartItemsPrice();
                        }else {
                            this.$message({
                                message:'Ëé∑ÂèñË¥≠Áâ©ËΩ¶Â§±Ë¥•',
                                type: 'warning'
                            })
                        }
                    }).catch((err) =>{
                        this.$message({
                            message:err.message,
                            type: 'warning'
                        })
                    })
                    this.updateUrlItemNumber('2');
                    console.log('Ë¥≠Áâ©ËΩ¶');
                },
                toOrder(){
                    this.isUserDetailPage = false;
                    this.isOrderPage = true;
                    this.isShoppingPage = false;
                    this.isSettingPage = false;
                    this.updateUrlItemNumber('3');
                    console.log('ËÆ¢Âçï')
                },
                toSetting(){
                    this.isUserDetailPage = false;
                    this.isOrderPage = false;
                    this.isShoppingPage = false;
                    this.isSettingPage = true;
                    this.updateUrlItemNumber('4');
                    console.log('ËÆæÁΩÆ')
                },
                async initDistricts() {
                    const response = await axios.post('http://localhost:8080/user/initDistricts');
                    // ËΩ¨Êç¢ÊâÄÊúâvalue‰∏∫Â≠óÁ¨¶‰∏≤
                    const convertValues = (nodes) => {
                        return nodes.map(node => ({
                            ...node,
                            value: String(node.value), // Âº∫Âà∂ËΩ¨‰∏∫Â≠óÁ¨¶‰∏≤
                            children: node.children ? convertValues(node.children) : []
                        }));
                    };

                    this.districts = convertValues(response.data);
                    console.log(this.districts);
                },
                getUserInfo(){
                    axios.post('http://localhost:8080/user/getUserInfo',
                    ).then(response => {
                        if (response.status === 200) {
                            this.$message({
                                message: 'Ëé∑ÂèñÁî®Êà∑ÊàêÂäü',
                                type: 'success'
                            });
                            this.loginedUSerData = response.data;
                        } else {
                            this.$message({
                                message: 'Ëé∑ÂèñÁî®Êà∑Â§±Ë¥•',
                                type: 'warning'
                            });
                            console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö', response.status);
                        }
                    }).catch(error => {
                        this.$message({
                            message: 'Ëé∑ÂèñÁî®Êà∑Â§±Ë¥•',
                            type: 'warning'
                        });
                        console.error('ËØ∑Ê±ÇÂá∫ÈîôÔºö', error);
                    });
                },
                editUserInfo(){
                    this.showDialog = true;
                    this.isEdit = true;
                    // this.editForm = {
                    //     id: this.loginedUSerData.id,
                    //     name: this.loginedUSerData.name,
                    //     city: this.loginedUSerData.city,
                    //     avatar: this.loginedUSerData.avatar,
                    //     gender: this.loginedUSerData.gender,
                    // };
                    this.editForm = {...this.loginedUSerData}
                },

                onSubmit(){
                    if (Array.isArray(this.editForm.city)) {
                        this.editForm.city = Number(this.editForm.city[this.editForm.city.length - 1]); // ËΩ¨Êç¢‰∏∫Êï∞Â≠ó
                    }
                    if (this.editForm.gender === '' || this.editForm.name === '') {
                        this.$message({
                           message:'ËØ∑ÂÆåÊàêÂÖàË°•ÂÖ®ÊÄßÂà´ÂíåÂßìÂêç',
                           type: 'warning'
                        });
                        return false;
                    }
                    axios.post('http://localhost:8080/user/edit',
                        this.editForm
                    ).then(response=>{
                        if(response.status === 200){
                            this.getUserInfo();
                            this.showDialog = false;
                            this.isEdit = false;
                        }
                    })
                },
                calculateTotal() {
                    this.calculateCartItemsPrice();
                    let total = 0;
                    this.userShoppingCarts.forEach(item => {
                        if (item.isSelected) {
                            // ËÆ°ÁÆóËßÑÊ†º‰ª∑Ê†ºÊÄªÂíå
                            let unitPrice = 0;
                            if (item.specsPrice && typeof item.specsPrice === 'object') {
                                Object.values(item.specsPrice).forEach(price => {
                                    unitPrice += parseFloat(price) || 0;
                                });
                            }
                            total += unitPrice * (item.quantity || 1);
                        }
                    });
                    this.finalBuyPrice = parseFloat(total); // ‰øùÁïô‰∏§‰ΩçÂ∞èÊï∞
                },

                // ÁªìÁÆóÊåâÈíÆÂ§ÑÁêÜÂáΩÊï∞
                confirmBuy() {
                    // 1. Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÂïÜÂìÅ
                    const selectedItems = this.userShoppingCarts.filter(item => item.isSelected);
                    if (selectedItems.length === 0) {
                        this.$message.warning('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰ª∂ÂïÜÂìÅËøõË°åÁªìÁÆó');
                        return;
                    }

                    // 2. ËøôÈáåÂèØÊ∑ªÂä†ÁªìÁÆóÈÄªËæëÔºàAPIË∞ÉÁî®Á≠âÔºâ
                    console.log('ÁªìÁÆóÁöÑÂïÜÂìÅ:', selectedItems);
                    console.log('ÊÄªÈáëÈ¢ù:', this.finalBuyPrice);

                    // 3. ÊèêÁ§∫Áî®Êà∑
                    this.$message.success(`ÁªìÁÆóÊàêÂäüÔºÅÊÄªÈáëÈ¢ùÔºö¬•${this.finalBuyPrice}`);
                }
            },

            watch: {
            },
            computed: {

            }

        });
        for(const[key, component] of Object.entries(ElementPlusIconsVue)) {app.component(key, component)}
        app.use(ElementPlus).use(VxeUITable).mount('#app');
    </script>
</body>
</html>