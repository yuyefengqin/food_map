<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gok.food_map.order.mapper.ProductOrderMapper">

    <select id="selectBy" resultType="com.gok.food_map.order.vo.OrderGetListVO">
        SELECT
        p.order_id as orderId,
        <!-- 用户编码处理 -->
        <choose>
            <when test="userCode != null">
                u.code as userCode,
            </when>
            <otherwise>
                (SELECT code FROM m_user WHERE id = p.user_id) as userCode,
            </otherwise>
        </choose>
        p.merchant_id as merchantId,
        <!-- 商户名称处理 -->
        <choose>
            <when test="merchantName != null">
                m.merchant_name as merchantName,
            </when>
            <otherwise>
                (SELECT merchant_name FROM m_merchant WHERE merchant_id = p.merchant_id) as merchantName,
            </otherwise>
        </choose>
        p.order_amount as orderAmount,
        p.product_amount as productAmount,
        p.delivery_fee as deliveryFee,
        p.delivery_method as deliveryMethod,
        p.address_id as addressId,
        p.pay_method as payMethod,
        p.trade_no as tradeNo,
        p.logistics_company as logisticsCompany,
        p.logistics_no as logisticsNo,
        p.order_status as orderStatus,
        p.create_time as createTime
        FROM product_order AS p
        <!-- 使用LEFT JOIN确保即使关联表没有数据也能返回订单 -->
        LEFT JOIN m_user AS u ON p.user_id = u.id
        LEFT JOIN m_merchant AS m ON p.merchant_id = m.merchant_id
        <where>
            <!-- 当userCode参数不为空时，添加用户编码过滤条件 -->
            <if test="userCode != null">
                AND u.code = #{userCode}
            </if>
            <!-- 当merchantName参数不为空时，添加商户名称过滤条件 -->
            <if test="merchantName != null">
                AND m.merchant_name LIKE CONCAT('%', #{merchantName}, '%')
            </if>
            <!-- 其他查询条件 -->
            <if test="orderId != null">
                AND p.order_id = #{orderId}
            </if>
            <if test="orderStatus != null">
                AND p.order_status = #{orderStatus}
            </if>
            <if test="payMethod != null">
                AND p.pay_method LIKE CONCAT('%', #{payMethod}, '%')
            </if>
            <if test="beginTime != null">
                AND p.create_time &gt;= #{beginTime}
            </if>
            <if test="endTime != null">
                AND p.create_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY p.create_time DESC
    </select>
</mapper>